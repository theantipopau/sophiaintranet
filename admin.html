<!DOCTYPE html>
<html lang="en" aria-label="Sophia College Admin Dashboard">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Sophia College – Admin Dashboard</title>
  <link rel="icon" href="logo.ico" type="image/x-icon">
  <link rel="stylesheet" href="shared/common-styles.css">
  
  <!-- Firebase SDKs v11.7.1 -->
  <script src="https://www.gstatic.com/firebasejs/11.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.7.1/firebase-firestore-compat.js"></script>
  <!-- PapaParse -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <!-- Unified Sophia System -->
  <script src="shared/sophia-unified-system.js"></script>
  <!-- Critical Fixes (MUST load before admin.js) -->
  <script src="js/critical-fixes.js"></script>
  
  <style>
    :root {
      /* Enhanced Color Palette */
      --primary-navy: #003057;
      --primary-maroon: #660000;
      --accent: #660000;
      --success: #059669;
      --warning: #d97706;
      --danger: #dc2626;
      --info: #0284c7;
      
      --white: #ffffff;
      --gray-50: #f8fafc;
      --gray-100: #f1f5f9;
      --gray-200: #e2e8f0;
      --gray-300: #cbd5e1;
      --gray-500: #64748b;
      --gray-700: #334155;
      --gray-900: #0f172a;
      
      --shadow: 0 4px 12px rgba(0,0,0,0.08);
      --shadow-lg: 0 10px 25px rgba(0,0,0,0.15);
      --border-radius: 12px;
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      --font-primary: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
    }

    * { 
      box-sizing: border-box; 
      margin: 0; 
      padding: 0; 
    }

    body {
      background: linear-gradient(135deg, #fbecec 0%, var(--gray-50) 100%);
      color: var(--gray-900);
      font-family: var(--font-primary);
      font-size: 14px;
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* Enhanced Navigation */
    .nav-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: var(--primary-navy);
      color: var(--white);
      padding: 12px 24px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      position: sticky;
      top: 0;
      z-index: 1000;
      flex-wrap: nowrap;
      backdrop-filter: blur(10px);
    }
    
    .nav-left {
      display: flex;
      align-items: center;
      flex-shrink: 0;
    }
    
    .nav-logo { 
      height: 42px; 
      margin-right: 16px; 
      transition: var(--transition);
      transform: translateZ(0);
    }
    .nav-logo:hover { transform: scale(1.05) rotate(2deg); }
    
    .nav-title { 
      font-size: 1.4em; 
      font-weight: 600; 
      letter-spacing: -0.5px; 
      white-space: nowrap; 
    }
    
    .nav-links { 
      display: flex; 
      align-items: center; 
      gap: 16px; 
      flex-shrink: 0; 
    }
    
    .theme-btn {
      background: none;
      border: none;
      color: var(--white);
      font-size: 1.4em;
      cursor: pointer;
      padding: 8px;
      border-radius: 50%;
      transition: var(--transition);
      transform: translateZ(0);
    }
    .theme-btn:hover {
      background: rgba(255,255,255,0.1);
      transform: scale(1.1) rotate(15deg);
    }
    
    #staffName { font-weight: 500; }
    .dropdown { position: relative; }
    .dropbtn {
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      color: var(--white);
      padding: 10px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 500;
      transition: var(--transition);
    }
    .dropbtn:hover { 
      background: rgba(255,255,255,0.2); 
      transform: translateY(-1px); 
    }
    
    .dropdown-content {
      display: none; 
      position: absolute; 
      right: 0; 
      background: var(--white);
      min-width: 220px; 
      box-shadow: var(--shadow-lg); 
      border-radius: var(--border-radius);
      overflow: hidden; 
      border: 1px solid var(--gray-200); 
      z-index: 1001; 
      padding-top: 8px; 
    }
    
    .dropdown-content a, .dropdown-content button {
      display: flex; 
      align-items: center; 
      gap: 12px; 
      padding: 14px 18px; 
      text-decoration: none;
      color: var(--gray-900); 
      background: none; 
      border: none; 
      width: 100%; 
      text-align: left;
      cursor: pointer; 
      font-size: 0.9em; 
      font-weight: 500; 
      transition: var(--transition);
      border-bottom: 1px solid var(--gray-100);
    }
    
    .dropdown-content a:last-child, 
    .dropdown-content button:last-child { 
      border-bottom: none; 
    }
    
    .dropdown-content a:hover, 
    .dropdown-content button:hover { 
      background: var(--gray-50); 
      transform: translateX(4px); 
    }
    
    .dropdown:hover .dropdown-content { display: block; }
    .dropdown-content {
      animation: fadeIn 0.2s ease-in-out;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .dropdown:hover .dropdown-content,
    .dropdown-content:hover {
      display: block;
    }

    .dropdown-content a.active {
      background-color: #f0f0f0;
      color: var(--accent);
      font-weight: 600;
      pointer-events: none;
    }

    /* Main Container & Loading State */
    .container { 
      max-width: 1400px; 
      margin: 0 auto; 
      padding: 24px; 
    }
    
    .loading-state { 
      text-align: center; 
      padding: 4rem 2rem; 
      color: var(--gray-500);
      min-height: 300px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    
    .loading-spinner {
      border: 4px solid var(--gray-200); 
      border-top: 4px solid var(--primary-navy);
      border-radius: 50%; 
      width: 48px; 
      height: 48px; 
      animation: spin 1s linear infinite;
      margin: 0 auto 1.5rem;
      transform: translateZ(0);
    }
    
    @keyframes spin { 
      to { transform: rotate(360deg); } 
    }

    #mainInterface {
      position: relative; 
    }

    /* Enhanced Header */
    .header-section {
      text-align: center; 
      margin-bottom: 32px; 
      padding: 32px 24px;
      background: var(--white); 
      border-radius: var(--border-radius);
      box-shadow: var(--shadow); 
      border: 1px solid var(--gray-200);
      border-left: 4px solid var(--primary-navy);
    }
    
    .header-section h1 {
      font-size: 2.25rem; 
      font-weight: 700; 
      color: var(--primary-navy);
      letter-spacing: -0.025em; 
      margin: 0 0 8px 0;
    }
    
    .header-section p { 
      color: var(--gray-500); 
      font-size: 1.1rem; 
      margin-bottom: 16px;
    }

    /* Communication System Info Banner */
    .communication-info {
      background: linear-gradient(135deg, #e0f2fe 0%, #f0f9ff 100%);
      border: 1px solid var(--info);
      border-radius: var(--border-radius);
      padding: 20px;
      margin: 20px 0;
      border-left: 4px solid var(--info);
    }

    .communication-info h3 {
      color: var(--info);
      margin: 0 0 12px 0;
      font-size: 1.1rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .communication-info .steps-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
      margin-top: 12px;
    }

    .step-item {
      background: white;
      padding: 12px;
      border-radius: 8px;
      border-left: 3px solid var(--info);
      font-size: 0.9rem;
    }

    .step-number {
      font-weight: 600;
      color: var(--info);
    }

    /* Enhanced Stats Grid */
    .stats-grid {
      display: grid; 
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 24px; 
      margin-bottom: 32px;
    }
    
    .stat-card {
      background: var(--white); 
      padding: 24px; 
      border-radius: var(--border-radius);
      box-shadow: var(--shadow); 
      border: 1px solid var(--gray-200);
      text-align: center; 
      border-top: 4px solid var(--primary-navy); 
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }
    
    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--primary-navy), var(--primary-maroon));
    }
    
    .stat-card:hover { 
      transform: translateY(-4px); 
      box-shadow: var(--shadow-lg); 
    }
    
    .stat-card .icon { 
      font-size: 2.5rem; 
      margin-bottom: 12px; 
      opacity: 0.8; 
    }
    
    .stat-card .number { 
      font-size: 2.5rem; 
      font-weight: 700; 
      color: var(--primary-navy); 
      line-height: 1; 
    }
    
    .stat-card .label { 
      color: var(--gray-500); 
      font-size: 0.875rem; 
      font-weight: 500; 
      text-transform: uppercase; 
      margin-top: 8px;
    }

    /* Enhanced Tab Navigation */
    .tab-navigation {
      display: flex; 
      background: var(--white); 
      border-radius: 50px;
      padding: 8px; 
      margin-bottom: 24px; 
      box-shadow: var(--shadow);
      border: 1px solid var(--gray-200); 
      gap: 8px; 
      overflow-x: auto;
    }
    
    .tab-btn {
      flex: 1; 
      min-width: 140px; 
      padding: 14px 20px; 
      background: transparent;
      border: none; 
      border-radius: 50px; 
      cursor: pointer; 
      font-weight: 600;
      color: var(--gray-500); 
      font-size: 0.9rem; 
      transition: var(--transition); 
      white-space: nowrap;
      transform: translateZ(0);
      position: relative;
    }
    
    .tab-btn:hover { 
      background: var(--gray-100); 
      color: var(--gray-700); 
      transform: translateY(-1px);
    }
    
    .tab-btn.active { 
      background: linear-gradient(135deg, var(--primary-navy), var(--primary-maroon)); 
      color: var(--white); 
      box-shadow: var(--shadow); 
      transform: translateY(-2px);
    }
    
    .tab-content {
      display: none;
      position: relative; 
      z-index: 1;         
    }
    
    .tab-content.active {
      display: block;
      animation: fadeInUp 0.3s ease-out;
    }

    @keyframes fadeInUp {
      from { 
        opacity: 0; 
        transform: translateY(20px); 
      }
      to { 
        opacity: 1; 
        transform: translateY(0); 
      }
    }

    /* Enhanced Controls & Forms */
    .controls-section { 
      background: var(--white); 
      padding: 24px; 
      border-radius: var(--border-radius); 
      box-shadow: var(--shadow); 
      border: 1px solid var(--gray-200); 
      margin-bottom: 24px;
      border-left: 4px solid var(--primary-navy);
    }
    
    .controls-grid { 
      display: grid; 
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
      gap: 20px; 
      align-items: end; 
    }
    
    .control-group label { 
      display: block; 
      margin-bottom: 8px; 
      font-weight: 500; 
      color: var(--gray-700); 
    }
    
    .control-group input, 
    .control-group select {
      width: 100%; 
      padding: 12px; 
      border: 2px solid var(--gray-200); 
      border-radius: 8px;
      font-size: 0.9rem; 
      transition: var(--transition);
      background: var(--white);
    }
    
    .control-group input:focus, 
    .control-group select:focus { 
      outline: none; 
      border-color: var(--primary-navy); 
      box-shadow: 0 0 0 3px rgba(0, 48, 87, 0.1); 
    }

    /* Enhanced Buttons */
    .btn {
      padding: 12px 20px; 
      border: none; 
      border-radius: 8px; 
      cursor: pointer;
      font-size: 0.9rem; 
      font-weight: 600; 
      text-decoration: none; 
      display: inline-flex;
      align-items: center; 
      gap: 8px; 
      transition: var(--transition);
      position: relative;
      overflow: hidden;
      transform: translateZ(0);
    }
    
    .btn:hover:not(:disabled) { 
      transform: translateY(-2px); 
      box-shadow: var(--shadow-lg); 
    }
    
    .btn:active:not(:disabled) {
      transform: translateY(0);
    }
    
    .btn:disabled { 
      opacity: 0.6; 
      cursor: not-allowed; 
      transform: none; 
      box-shadow: none; 
    }
    
    .btn-primary { 
      background: linear-gradient(135deg, var(--primary-navy), var(--primary-maroon)); 
      color: var(--white); 
    }
    
    .btn-danger { 
      background: linear-gradient(135deg, var(--danger), #b91c1c); 
      color: var(--white); 
    }
    
    .btn-secondary { 
      background: var(--gray-100); 
      color: var(--gray-700); 
      border: 1px solid var(--gray-300); 
    }
    
    .btn-success { 
      background: linear-gradient(135deg, var(--success), #047857); 
      color: var(--white); 
    }
    
    .btn-warning { 
      background: linear-gradient(135deg, var(--warning), #b45309); 
      color: var(--white); 
    }

    /* Enhanced Tables & Data Cards */
    .data-card { 
      background: var(--white); 
      border-radius: var(--border-radius); 
      box-shadow: var(--shadow); 
      margin-bottom: 24px; 
      border: 1px solid var(--gray-200);
      overflow: hidden;
    }
    
    .data-card-header { 
      padding: 20px 24px; 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      border-bottom: 1px solid var(--gray-200);
      background: linear-gradient(135deg, var(--gray-50), var(--white));
    }
    
    .data-card-title { 
      font-size: 1.25rem; 
      font-weight: 600; 
      margin: 0; 
      color: var(--primary-navy); 
    }
    
    .data-card-badge { 
      background: var(--gray-100); 
      color: var(--primary-navy); 
      padding: 6px 12px; 
      border-radius: 50px; 
      font-size: 0.8rem; 
      font-weight: 600; 
    }
    
    .table-container { 
      max-height: 500px; 
      overflow-y: auto; 
    }
    
    table { 
      width: 100%; 
      border-collapse: collapse; 
      font-size: 0.9rem; 
    }
    
    th, td { 
      padding: 14px 16px; 
      text-align: left; 
      border-bottom: 1px solid var(--gray-200); 
    }
    
    th { 
      background: var(--gray-50); 
      font-weight: 600; 
      color: var(--gray-700); 
      position: sticky; 
      top: 0;
      z-index: 10;
    }
    
    tbody tr {
      transition: var(--transition);
    }
    
    tbody tr:hover { 
      background: var(--gray-50); 
    }
    
    .selected-row { 
      background: rgba(0, 48, 87, 0.1) !important; 
    }
    
    /* Enhanced Status Indicators & Badges */
    .status-indicator { 
      display: inline-block; 
      padding: 4px 10px; 
      border-radius: 50px; 
      font-size: 0.75rem; 
      font-weight: 600; 
    }
    
    .status-step-0 { background: #dbeafe; color: #1e40af; }
    .status-step-1 { background: #fef3c7; color: #92400e; }
    .status-step-2 { background: #fed7aa; color: #c2410c; }
    .status-step-3 { background: #fecaca; color: #dc2626; }
    .status-step-4 { background: #fca5a5; color: #b91c1c; }
    .status-step-5 { background: #f87171; color: #991b1b; }
    .status-step-6 { background: #ef4444; color: var(--white); }
    
    .email-sent { background: #d1fae5; color: #065f46; }
    .badge { padding: 4px 10px; border-radius: 50px; font-size: 0.8rem; font-weight: 500; }
    .badge-primary { background: #e0e7ff; color: #3730a3; }
    .badge-warning { background: #fef3c7; color: #92400e; }
    .badge-danger { background: #fecaca; color: #dc2626; }

    /* Enhanced Bulk Actions */
    .bulk-actions-bar { 
      background: linear-gradient(135deg, #fffbeb, #fef3c7); 
      border: 1px solid var(--warning); 
      border-radius: var(--border-radius); 
      padding: 16px 20px; 
      margin-bottom: 24px; 
      display: flex; 
      justify-content: space-between; 
      align-items: center;
      box-shadow: var(--shadow);
    }
    
    .bulk-info { 
      font-weight: 600; 
      color: #b45309; 
    }
    
    .bulk-buttons { 
      display: flex; 
      gap: 12px; 
    }

    /* Enhanced Charts */
    .charts-grid { 
      display: grid; 
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); 
      gap: 24px; 
    }
    
    .chart-card { 
      background: var(--white); 
      padding: 24px; 
      border-radius: var(--border-radius); 
      box-shadow: var(--shadow); 
      border: 1px solid var(--gray-200);
      position: relative;
    }
    
    .chart-title { 
      font-size: 1.1rem; 
      font-weight: 600; 
      text-align: center; 
      margin: 0 0 20px 0; 
      color: var(--primary-navy);
    }
    
    .chart-card canvas { 
      width: 100% !important; 
      height: 250px !important; 
    }
    
    .empty-chart-message { 
      text-align: center; 
      padding: 3rem 1rem; 
      color: var(--gray-500); 
      font-style: italic; 
      min-height: 250px; 
      display: flex; 
      flex-direction: column; 
      justify-content: center; 
      align-items: center; 
      border: 2px dashed var(--gray-300); 
      border-radius: var(--border-radius); 
    }

    /* Enhanced Loading Overlay for Charts */
    .chart-loading {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.9);
      display: flex;
      justify-content: center;
      align-items: center;
      border-radius: var(--border-radius);
      z-index: 10;
    }

    /* Enhanced Semester Controls */
    .semester-controls { 
      background: linear-gradient(135deg, #fff1f2, #fef2f2); 
      border: 1px solid var(--danger); 
      border-radius: var(--border-radius); 
      padding: 24px; 
      margin-bottom: 24px; 
      text-align: center; 
      box-shadow: var(--shadow);
      border-left: 4px solid var(--danger);
    }
    
    .semester-controls h4 { 
      color: var(--danger); 
      font-size: 1.1rem; 
      font-weight: 600; 
      margin: 0 0 8px 0; 
    }
    
    .semester-controls p { 
      color: #881337; 
      margin: 0 0 16px 0; 
    }

    /* Enhanced Sortable Headers */
    .sortable { 
      cursor: pointer; 
      user-select: none; 
      position: relative;
      transition: var(--transition);
    }
    
    .sortable:hover { 
      background: var(--gray-100); 
    }
    
    .sortable::after { 
      content: '↕️'; 
      opacity: 0.5; 
      margin-left: 6px; 
    }
    
    .sortable.sort-asc::after { 
      content: '↑'; 
      opacity: 1; 
      color: var(--primary-navy);
    }
    
    .sortable.sort-desc::after { 
      content: '↓'; 
      opacity: 1; 
      color: var(--primary-navy);
    }

    /* Enhanced Modal Styles */
    .modal-overlay { 
      position: fixed; 
      top: 0; 
      left: 0; 
      width: 100%; 
      height: 100%; 
      background: rgba(0,0,0,0.6); 
      display: flex; 
      justify-content: center; 
      align-items: center; 
      z-index: 10000; 
      backdrop-filter: blur(5px);
      animation: fadeIn 0.2s ease-out;
    }
    
    .modal-content { 
      background: white; 
      border-radius: var(--border-radius); 
      max-width: 600px; 
      width: 90%; 
      max-height: 80vh; 
      overflow: hidden; 
      display: flex; 
      flex-direction: column; 
      box-shadow: var(--shadow-lg);
      animation: slideInUp 0.3s ease-out;
    }

    @keyframes slideInUp {
      from { 
        opacity: 0; 
        transform: translateY(50px); 
      }
      to { 
        opacity: 1; 
        transform: translateY(0); 
      }
    }
    
    .modal-header { 
      background: var(--primary-navy); 
      color: white; 
      padding: 20px; 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
    }
    
    .modal-title { 
      margin: 0; 
      font-size: 1.25rem; 
      font-weight: 600; 
    }
    
    .modal-close { 
      background: none; 
      border: none; 
      color: white; 
      font-size: 24px; 
      cursor: pointer; 
      opacity: 0.8;
      transition: var(--transition);
    }
    
    .modal-close:hover { 
      opacity: 1; 
      transform: scale(1.1);
    }
    
    .modal-body { 
      padding: 24px; 
      overflow-y: auto; 
      flex: 1; 
    }
    
    .modal-footer { 
      padding: 20px; 
      border-top: 1px solid var(--gray-200); 
      display: flex; 
      justify-content: flex-end; 
      gap: 12px; 
    }

    /* Enhanced Empty States */
    .empty-state { 
      text-align: center; 
      padding: 3rem 2rem; 
      color: var(--gray-500); 
      font-style: italic; 
    }
    
    .empty-state-icon { 
      font-size: 3rem; 
      margin-bottom: 1rem; 
      opacity: 0.5; 
    }
    
    .empty-state-title { 
      font-size: 1.1rem; 
      font-weight: 600; 
      margin-bottom: 0.5rem; 
      color: var(--gray-700); 
    }
    
    .empty-state-desc { 
      font-size: 0.9rem; 
      color: var(--gray-500); 
    }

    /* Enhanced Search Highlighting */
    .search-highlight {
      background: linear-gradient(135deg, #fef3c7, #fbbf24);
      color: #92400e;
      padding: 2px 4px;
      border-radius: 4px;
      font-weight: 600;
    }

    .row-warning {
      background: linear-gradient(135deg, #fffbeb, #fef3c7) !important;
      border-left: 4px solid var(--warning) !important;
    }

    /* Enhanced Quick Actions */
    .quick-actions {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }
    
    .quick-action-btn {
      padding: 10px 16px;
      background: var(--gray-100);
      border: 1px solid var(--gray-300);
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 500;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      gap: 6px;
      transform: translateZ(0);
    }
    
    .quick-action-btn:hover {
      background: linear-gradient(135deg, var(--primary-navy), var(--primary-maroon));
      color: var(--white);
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }

    /* Enhanced Utilities */
    .text-strong { 
      font-weight: 600; 
      color: var(--gray-900); 
    }
    
    .text-muted { 
      color: var(--gray-500); 
      font-size: 0.875rem; 
    }

    /* Enhanced Footer */
    .footer { 
      margin-top: 48px; 
      font-size: 0.875rem; 
      color: var(--gray-500); 
      padding-top: 24px; 
      border-top: 1px solid var(--gray-200); 
      text-align: center;
      background: var(--white);
      border-radius: var(--border-radius);
      padding: 24px;
      box-shadow: var(--shadow);
    }
    
    .footer a { 
      color: var(--primary-navy); 
      text-decoration: none; 
      margin: 0 8px; 
      font-weight: 500;
      transition: var(--transition);
    }

    .footer a:hover {
      color: var(--primary-maroon);
      text-decoration: underline;
    }

    /* Enhanced Skip Links for Accessibility */
    .skip-links {
      list-style: none;
      margin: 0;
      padding: 0;
      position: absolute;
      top: 0;
      left: 0;
      z-index: 10001; 
    }
    
    .skip-link {
      position: absolute;
      left: -9999px;
      top: auto;
      width: 1px;
      height: 1px;
      overflow: hidden;
      background: var(--accent);
      color: white;
      padding: 10px 18px;
      text-decoration: none;
      border-radius: 0 0 6px 6px;
      font-weight: 600;
      font-size: 0.95em;
      box-shadow: 0 3px 10px rgba(0,0,0,0.3);
      transition: none;
    }
    
    .skip-link:focus {
      left: 8px;
      top: 8px;
      width: auto;
      height: auto;
      overflow: visible;
      transition: background-color 0.3s ease, color 0.3s ease;
    }

    /* Enhanced Connection Status */
    .connection-status {
      position: fixed;
      bottom: 20px;
      left: 20px;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 0.8em;
      font-weight: 500;
      transition: var(--transition);
      z-index: 1000;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.2);
      display: none;
    }
    
    .connection-status.online {
      background: linear-gradient(135deg, var(--success), #20c997);
      color: white;
      box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
    }
    
    .connection-status.offline {
      background: linear-gradient(135deg, var(--danger), #c82333);
      color: white;
      box-shadow: 0 2px 8px rgba(220, 53, 69, 0.3);
    }
    
    .connection-status.loading {
      background: linear-gradient(135deg, var(--warning), #e0a800);
      color: #333;
      box-shadow: 0 2px 8px rgba(255, 193, 7, 0.3);
    }

    /* Enhanced Dark Mode Styles */
    .dark-mode {
      --primary-navy: #003057;
      --primary-maroon: #660000;
      --accent: #7e2a2a;

      --bg: linear-gradient(135deg, #1e1e2f 0%, #2d2d3f 100%);
      --card-bg: #2d2d3f;
      --text: #e0e0e0;
      --gray-50: #2a2a3a;
      --gray-100: #3c3c4d;
      --gray-200: #4d4d5e;
      --gray-300: #5e5e6f;
      --gray-500: #9090a1;
      --gray-700: #c1c1d2;
      --gray-900: #f0f0f1;

      --shadow: 0 4px 12px rgba(0,0,0,0.2);
      --shadow-lg: 0 10px 25px rgba(0,0,0,0.3);
    }
    
    .dark-mode body {
      background: var(--bg);
      color: var(--text);
    }
    
    .dark-mode .nav-bar {
      background: rgba(0, 48, 87, 0.85);
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    
    .dark-mode .header-section,
    .dark-mode .stat-card,
    .dark-mode .tab-navigation,
    .dark-mode .controls-section,
    .dark-mode .data-card,
    .dark-mode .chart-card,
    .dark-mode .semester-controls,
    .dark-mode .dropdown-content,
    .dark-mode .footer {
      background: var(--card-bg);
      border-color: var(--gray-300);
      color: var(--text);
    }
    
    .dark-mode .header-section h1, 
    .dark-mode .data-card-title { 
      color: var(--gray-50); 
    }
    
    .dark-mode .header-section p, 
    .dark-mode .stat-card .label, 
    .dark-mode .semester-controls p { 
      color: var(--gray-500); 
    }
    
    .dark-mode .stat-card .number { 
      color: var(--gray-50); 
    }
    
    .dark-mode .tab-btn { 
      color: var(--gray-500); 
    }
    
    .dark-mode .tab-btn:hover { 
      background: var(--gray-100); 
      color: var(--gray-700); 
    }
    
    .dark-mode .tab-btn.active { 
      background: linear-gradient(135deg, var(--accent), var(--primary-maroon)); 
      color: var(--white); 
    }
    
    .dark-mode .control-group label { 
      color: var(--gray-700); 
    }
    
    .dark-mode .control-group input, 
    .dark-mode .control-group select {
      background: var(--gray-100);
      border-color: var(--gray-300);
      color: var(--text);
    }
    
    .dark-mode .control-group input:focus, 
    .dark-mode .control-group select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(126, 42, 42, 0.2);
    }
    
    .dark-mode th { 
      background: var(--gray-100); 
      color: var(--gray-700); 
    }
    
    .dark-mode tbody tr:hover { 
      background: var(--gray-50); 
    }
    
    .dark-mode .selected-row { 
      background: rgba(126, 42, 42, 0.15) !important; 
    }
    
    .dark-mode .dropdown-content a, 
    .dark-mode .dropdown-content button {
      color: var(--text);
      border-bottom-color: var(--gray-100);
    }
    
    .dark-mode .dropdown-content a:hover, 
    .dark-mode .dropdown-content button:hover {
      background: var(--gray-50);
    }
    
    .dark-mode .footer {
      border-top-color: var(--gray-300);
      color: var(--gray-500);
    }
    
    .dark-mode .footer a { 
      color: var(--accent); 
    }
    
    .dark-mode .loading-spinner {
      border-top-color: var(--accent);
    }
    
    .dark-mode .empty-state-icon { 
      opacity: 0.3; 
    }
    
    .dark-mode .empty-state-title { 
      color: var(--gray-700); 
    }
    
    .dark-mode .empty-state-desc { 
      color: var(--gray-500); 
    }
    
    .dark-mode .search-highlight { 
      background: #b45309; 
      color: #fff5eb; 
    }
    
    .dark-mode .quick-action-btn {
      background: var(--gray-100);
      border-color: var(--gray-300);
      color: var(--gray-700);
    }
    
    .dark-mode .quick-action-btn:hover {
      background: linear-gradient(135deg, var(--accent), var(--primary-maroon));
      color: var(--white);
    }
    
    .dark-mode .chart-loading { 
      background: rgba(45, 45, 63, 0.8); 
    }
    
    .dark-mode .empty-chart-message { 
      border-color: var(--gray-300); 
      color: var(--gray-500); 
    }

    .dark-mode .connection-status.loading {
      color: var(--gray-900);
    }

    /* Enhanced Responsive Design */
    @media (max-width: 1024px) {
      .stats-grid { 
        grid-template-columns: repeat(3, 1fr); 
      }
      
      .controls-grid { 
        grid-template-columns: repeat(2, 1fr); 
      }
      
      .charts-grid { 
        grid-template-columns: repeat(2, 1fr); 
      }
    }
    
    @media (max-width: 768px) {
      .container {
        padding: 16px;
      }
      
      .stats-grid { 
        grid-template-columns: repeat(2, 1fr); 
        gap: 16px;
      }
      
      .controls-grid { 
        grid-template-columns: 1fr; 
      }
      
      .bulk-actions-bar { 
        flex-direction: column; 
        gap: 12px; 
      }
      
      .charts-grid { 
        grid-template-columns: 1fr; 
      }
      
      .nav-bar {
        padding: 8px 16px;
      }
      
      .nav-title {
        font-size: 1.2em;
      }
      
      .header-section {
        padding: 24px 16px;
      }
      
      .header-section h1 {
        font-size: 1.8rem;
      }
      
      .tab-navigation {
        padding: 6px;
        gap: 4px;
      }
      
      .tab-btn {
        min-width: 120px;
        padding: 12px 16px;
        font-size: 0.85rem;
      }
    }
    
    @media (max-width: 480px) {
      .stats-grid { 
        grid-template-columns: 1fr; 
      }
      
      .header-section h1 {
        font-size: 1.6rem;
      }
      
      .communication-info .steps-grid {
        grid-template-columns: 1fr;
      }
      
      .nav-links {
        gap: 8px;
      }
      
      .dropbtn {
        padding: 8px 12px;
        font-size: 0.85rem;
      }
    }

    /* Print Styles */
    @media print {
      .nav-bar,
      .footer,
      .btn,
      .bulk-actions-bar,
      .quick-actions,
      .semester-controls {
        display: none !important;
      }
      
      .container {
        max-width: none;
        padding: 0;
      }
      
      .data-card {
        box-shadow: none;
        border: 1px solid #ccc;
      }
      
      .tab-content {
        display: block !important;
      }
      
      .chart-card {
        break-inside: avoid;
      }
    }
  </style>
</head>
<body>
  <div class="skip-links">
    <a href="#mainInterface" class="skip-link">Skip to main content</a>
    <a href="#infringements-tab" class="skip-link">Skip to Infringements</a>
    <a href="#emails-tab" class="skip-link">Skip to Communications</a>
    <a href="#outofclass-tab" class="skip-link">Skip to Out-of-Class</a>
    <a href="#affirmations-tab" class="skip-link">Skip to Affirmations</a>
    <a href="#analytics-tab" class="skip-link">Skip to Analytics</a>
  </div>

  <!-- Enhanced Navigation -->
  <nav class="nav-bar" role="navigation" aria-label="Main navigation">
    <div class="nav-left">
      <img src="crest.png" alt="College Crest" class="nav-logo">
    </div>
    <div class="nav-title">👥 Admin Dashboard</div>
    <div class="nav-right">
      <div class="nav-links">
        <span id="staffName" aria-live="polite"></span>
        <button class="theme-btn" id="themeToggle" title="Toggle dark mode" aria-label="Toggle dark mode">🌓</button>
        <div class="dropdown">
          <button class="dropbtn" aria-label="Navigation menu" aria-expanded="false" aria-haspopup="true">
            ☰ Menu
          </button>
          <div class="dropdown-content" role="menu">
            <a href="home.html" onclick="navigate('home.html'); return false;" role="menuitem">🏠 Home</a>
            <a href="staff.html" onclick="navigate('staff.html'); return false;" role="menuitem">📝 Infringement Tracker</a>
            <a href="outofclass.html" onclick="navigate('outofclass.html'); return false;" role="menuitem">🏫 Out-of-Class Logger</a>
            <a href="positiveaffirmations.html" onclick="navigate('positiveaffirmations.html'); return false;" role="menuitem">✨ Positive Affirmations</a>
            <a href="reengagementroom.html" onclick="navigate('reengagementroom.html'); return false;" role="menuitem">🔄 Re-Engagement Room</a>
            <a href="admin.html" id="adminLink" onclick="navigate('admin.html'); return false;" role="menuitem">
              👥 Admin Dashboard 
              <span id="badge" class="badge" style="display:none;" aria-label="notifications"></span>
            </a>
            <button onclick="logout(); return false;" role="menuitem">🚪 Logout</button>
          </div>
        </div>
      </div>
    </div>
  </nav>

  <div class="container">
    <div id="loadingState" class="loading-state">
      <div class="loading-spinner"></div>
      <h2>Initializing Admin Dashboard</h2>
      <p>Loading system data and authenticating...</p>
    </div>

    <div id="mainInterface" style="display: none;">
      
      <div class="header-section">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
          <div>
            <h1 style="margin: 0;">Administrative Control Center</h1>
            <p style="margin: 8px 0 0 0;">Comprehensive management of student behavior tracking and communications</p>
          </div>
          <div style="display: flex; gap: 12px; align-items: center;">
            <button class="btn btn-secondary" onclick="adminSystem.refreshData()" title="Refresh all data">
              🔄 Refresh
            </button>
            <div style="font-size: 0.85rem; color: var(--gray-500);" id="lastUpdated">
              Loading...
            </div>
          </div>
        </div>

        <!-- Enhanced Communication System Information -->
        <div class="communication-info">
          <h3>📧 Automated Communication System</h3>
          <p>The admin dashboard includes a comprehensive step-based email notification system that automatically tracks student infringement counts and triggers parent notifications at specific thresholds.</p>
          
          <div class="steps-grid">
            <div class="step-item">
              <span class="step-number">Step 1:</span> 5 infringements
            </div>
            <div class="step-item">
              <span class="step-number">Step 2:</span> 10 infringements
            </div>
            <div class="step-item">
              <span class="step-number">Step 3:</span> 15 infringements
            </div>
            <div class="step-item">
              <span class="step-number">Step 4:</span> 20 infringements
            </div>
            <div class="step-item">
              <span class="step-number">Step 5:</span> 25 infringements
            </div>
            <div class="step-item">
              <span class="step-number">Step 6:</span> 30+ infringements
            </div>
          </div>
          
          <p style="margin-top: 12px; font-size: 0.9rem;">
            <strong>Features:</strong> Email templates, status tracking, bulk operations, affirmation notifications, preview modals, and automatic parent/companion CC functionality.
          </p>
        </div>
      </div>

      <div class="stats-grid">
        <div class="stat-card">
          <div class="icon">📋</div>
          <div class="number" id="totalInfringements">0</div>
          <div class="label">Total Infringements</div>
        </div>
        <div class="stat-card">
          <div class="icon">📧</div>
          <div class="number" id="pendingEmails">0</div>
          <div class="label">Pending Emails</div>
        </div>
        <div class="stat-card">
          <div class="icon">🏫</div>
          <div class="number" id="totalOutOfClass">0</div>
          <div class="label">Out-of-Class Logs</div>
        </div>
        <div class="stat-card">
          <div class="icon">📈</div>
          <div class="number" id="todayActivity">0</div>
          <div class="label">Today's Activity</div>
        </div>
        <div class="stat-card">
          <div class="icon">⌚</div>
          <div class="number" id="lateToClass">0</div>
          <div class="label">Late to Class</div>
        </div>
      </div>

      <div class="tab-navigation">
        <button class="tab-btn active" onclick="switchTab('infringements', this)">📋 Infringements</button>
        <button class="tab-btn" onclick="switchTab('emails', this)">📧 Communications</button>
        <button class="tab-btn" onclick="switchTab('outofclass', this)">🏫 Out-of-Class</button>
        <button class="tab-btn" id="affirmationsNavTab" onclick="switchTab('affirmations', this)">✨ Affirmations</button>
        <button class="tab-btn" onclick="switchTab('analytics', this)">📊 Analytics</button>
      </div>

      <!-- Infringements Tab -->
      <div id="infringements-tab" class="tab-content active">
        <div class="controls-section">
          <div class="controls-grid">
            <div class="control-group"><label for="searchInfringements">🔍 Search Students</label><input type="text" id="searchInfringements" placeholder="Student name or ID..."></div>
            <div class="control-group"><label for="houseFilterInfr">🏠 House Filter</label><select id="houseFilterInfr"><option value="">All Houses</option></select></div>
            <div class="control-group"><label for="dateFilterInfr">📅 Date Filter</label><select id="dateFilterInfr"><option value="">All Time</option><option value="today">Today</option><option value="week">This Week</option><option value="month">This Month</option></select></div>
            <div class="control-group"><label> </label><button class="btn btn-secondary" onclick="exportInfringements()">📥 Export Data</button></div>
          </div>
        </div>
        <div id="bulkActionsBar" class="bulk-actions-bar" style="display: none;">
          <div class="bulk-info">📊 <span id="selectedCount">0</span> items selected</div>
          <div class="bulk-buttons">
            <button class="btn btn-secondary" onclick="selectAllInfringements()">Select All</button><button class="btn btn-secondary" onclick="clearSelectionInfringements()">Clear</button>
            <button class="btn btn-warning" onclick="bulkEmailParents()">📧 Email Parents</button><button class="btn btn-danger" onclick="bulkDeleteInfringements()">🗑️ Delete</button>
          </div>
        </div>
        <div class="data-card">
          <div class="data-card-header"><h3 class="data-card-title">Infringement Records</h3><span class="data-card-badge" id="infringementsCount">Loading...</span></div>
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th><input type="checkbox" id="selectAllInfr" onchange="toggleSelectAll('infringements')"></th>
                  <th class="sortable" onclick="sortTable('infringements', 'date')">Date</th><th class="sortable" onclick="sortTable('infringements', 'name')">Student</th>
                  <th class="sortable" onclick="sortTable('infringements', 'house')">House</th><th class="sortable" onclick="sortTable('infringements', 'infringement')">Infringement</th>
                  <th class="sortable" onclick="sortTable('infringements', 'infractions')">Infractions</th><th class="sortable" onclick="sortTable('infringements', 'step')">Step</th>
                  <th class="sortable" onclick="sortTable('infringements', 'staff')">Staff</th><th>Actions</th>
                </tr>
              </thead>
              <tbody id="infringementsTableBody">
                <tr class="empty-row">
                  <td colspan="9">
                    <div class="empty-state">
                      <div class="empty-state-icon">📋</div>
                      <div class="empty-state-title">Loading infringement records...</div>
                      <div class="empty-state-desc">Fetching student behavior data from the system</div>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
        <div class="semester-controls">
          <h4>🗂️ Semester Management</h4><p>Export all infringement and out-of-class data, then wipe the records to prepare for a new semester. This action cannot be undone.</p>
          <button class="btn btn-danger" onclick="showSemesterWipeWarning()">📤 Export & Wipe Data</button>
        </div>
      </div>

      <!-- Email Management Tab -->
      <div id="emails-tab" class="tab-content">
        <div class="quick-actions">
          <button class="quick-action-btn" onclick="adminSystem.sendAllPendingEmails()">
            📧 Send All Pending
          </button>
          <button class="quick-action-btn" onclick="adminSystem.previewEmailTemplate()">
            👁️ Preview Templates
          </button>
          <button class="quick-action-btn" onclick="adminSystem.exportEmailLog()">
            📥 Export Email Log
          </button>
        </div>
        
        <div class="data-card">
          <div class="data-card-header"><h3 class="data-card-title">Communication Center</h3><span class="data-card-badge" id="emailTriggersCount">0 pending</span></div>
          <div class="table-container">
            <table>
              <thead><tr><th>Student</th><th>House</th><th>Step</th><th>Count</th><th>Email Status</th><th>Actions</th></tr></thead>
              <tbody id="emailTriggersTableBody">
                <tr class="empty-row">
                  <td colspan="6">
                    <div class="empty-state">
                      <div class="empty-state-icon">📧</div>
                      <div class="empty-state-title">Loading communication triggers...</div>
                      <div class="empty-state-desc">Calculating step notifications for students</div>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Out of Class Tab -->
      <div id="outofclass-tab" class="tab-content">
        <div class="controls-section">
          <div class="controls-grid">
            <div class="control-group"><label for="searchOutOfClass">🔍 Search Records</label><input type="text" id="searchOutOfClass" placeholder="Name or reason..."></div>
            <div class="control-group"><label for="houseFilterOut">🏠 House Filter</label><select id="houseFilterOut"><option value="">All Houses</option></select></div>
            <div class="control-group"><label for="reasonFilter">📝 Reason Filter</label><select id="reasonFilter"><option value="">All Reasons</option></select></div>
            <div class="control-group"><label> </label><button class="btn btn-secondary" onclick="exportOutOfClass()">📥 Export Data</button></div>
          </div>
        </div>
        <div id="bulkActionsBarOut" class="bulk-actions-bar" style="display: none;">
          <div class="bulk-info">📊 <span id="selectedCountOut">0</span> items selected</div>
          <div class="bulk-buttons">
            <button class="btn btn-secondary" onclick="selectAllOutOfClass()">Select All</button><button class="btn btn-secondary" onclick="clearSelectionOutOfClass()">Clear</button>
            <button class="btn btn-danger" onclick="bulkDeleteOutOfClass()">🗑️ Delete</button>
          </div>
        </div>
        <div class="data-card">
          <div class="data-card-header"><h3 class="data-card-title">Out-of-Class Records</h3><span class="data-card-badge" id="outOfClassCount">Loading...</span></div>
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th><input type="checkbox" id="selectAllOut" onchange="toggleSelectAll('outofclass')"></th>
                  <th class="sortable" onclick="sortTable('outofclass', 'date')">Date</th>
                  <th class="sortable" onclick="sortTable('outofclass', 'name')">Student</th>
                  <th class="sortable" onclick="sortTable('outofclass', 'house')">House</th>
                  <th class="sortable" onclick="sortTable('outofclass', 'reason')">Reason</th>
                  <th class="sortable" onclick="sortTable('outofclass', 'details')">Details</th>
                  <th class="sortable" onclick="sortTable('outofclass', 'staff')">Staff</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="outOfClassTableBody">
                <tr class="empty-row">
                  <td colspan="8">
                    <div class="empty-state">
                      <div class="empty-state-icon">🏫</div>
                      <div class="empty-state-title">Loading out-of-class records...</div>
                      <div class="empty-state-desc">Retrieving student movement tracking data</div>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Analytics Tab -->
      <div id="analytics-tab" class="tab-content">
        <div class="charts-grid">
          <div class="chart-card"><h3 class="chart-title">Infringements by House</h3><canvas id="houseChart"></canvas></div>
          <div class="chart-card"><h3 class="chart-title">Infringement Types</h3><canvas id="infrTypeChart"></canvas></div>
          <div class="chart-card"><h3 class="chart-title">Top Students (by Infringements)</h3><canvas id="topStudentsChart"></canvas></div>
          <div class="chart-card"><h3 class="chart-title">Out-of-Class Reasons</h3><canvas id="outReasonChart"></canvas></div>
          <div class="chart-card"><h3 class="chart-title">Out-of-Class by House</h3><canvas id="outHouseChart"></canvas></div>
          <div class="chart-card"><h3 class="chart-title">Weekly Activity Trends</h3><canvas id="trendsChart"></canvas></div>
          <div class="chart-card"><h3 class="chart-title">Affirmations by House</h3><canvas id="affirmationsByHouseChart"></canvas></div>
          <div class="chart-card"><h3 class="chart-title">Top Staff (Affirmations)</h3><canvas id="topStaffAffirmationsChart"></canvas></div>
          <div class="chart-card"><h3 class="chart-title">Late to Class by House</h3><canvas id="lateByHouseChart"></canvas></div>
          <div class="chart-card"><h3 class="chart-title">Top Late Students</h3><canvas id="topLateStudentsChart"></canvas></div>
        </div>
      </div>

      <!-- Affirmations Tab -->
      <div id="affirmations-tab" class="tab-content">
        <div class="controls-section">
          <div class="controls-grid">
            <div class="control-group"><label for="searchAffirmations">🔍 Search Affirmations</label><input type="text" id="searchAffirmations" placeholder="Student name, affirmation text..."></div>
            <div class="control-group"><label for="houseFilterAffirmations">🏠 House Filter</label><select id="houseFilterAffirmations"><option value="">All Houses</option></select></div>
            <div class="control-group"><label for="dateFilterAffirmations">📅 Date Filter</label><select id="dateFilterAffirmations"><option value="">All Time</option><option value="today">Today</option><option value="week">This Week</option><option value="month">This Month</option></select></div>
            <div class="control-group"><label> </label><button class="btn btn-secondary" onclick="exportAffirmations()">📥 Export Data</button></div>
          </div>
        </div>
        <div class="data-card">
          <div class="data-card-header"><h3 class="data-card-title">Positive Affirmations</h3><span class="data-card-badge" id="affirmationsCount">Loading...</span></div>
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th class="sortable" onclick="sortTable('affirmations', 'date')">Date</th>
                  <th class="sortable" onclick="sortTable('affirmations', 'studentName')">Student</th>
                  <th class="sortable" onclick="sortTable('affirmations', 'house')">House</th>
                  <th class="sortable" onclick="sortTable('affirmations', 'affirmationText')">Affirmation</th>
                  <th class="sortable" onclick="sortTable('affirmations', 'staffName')">Submitted By</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="affirmationsTableBody">
                <tr class="empty-row"><td colspan="6"><div class="empty-state"><div class="empty-state-icon">✨</div><div class="empty-state-title">Loading affirmations...</div></div></td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

    </div>
  </div>

  <footer class="footer">
    <p>© 2025 Sophia College | 
      <a href="https://www.sophiacollege.qld.edu.au" target="_blank" rel="noopener">College Homepage</a> | 
      <a href="mailto:splaittech@bne.catholic.edu.au">IT Support</a> | 
      Enhanced Version 2.3
    </p>
  </footer>

  <div id="connectionStatus" class="connection-status loading" style="display:none;">
    <span id="connectionText">Connecting...</span>
  </div>

  <!-- Load the admin logic from external file -->
  <script src="js/admin.js"></script>
  
  <script>
    // Enhanced initialization with proper error handling
    document.addEventListener('DOMContentLoaded', async function() {
      // Wait for critical systems to be ready
      if (typeof ErrorHandler === 'undefined' || typeof UnifiedToast === 'undefined') {
        console.error('❌ Critical dependencies not loaded. Please ensure critical-fixes.js is loaded first.');
        return;
      }

      const currentPage = window.location.pathname.split('/').pop();
      const links = document.querySelectorAll('.dropdown-content a');
      links.forEach(link => {
          const linkPage = link.getAttribute('href');
          if (linkPage === currentPage) {
              link.classList.add('active');
              link.setAttribute('aria-current', 'page');
          }
      });

      initializeTheme();
      
      // Initialize admin system with proper error handling
      await ErrorHandler.safeAsync(async () => {
        console.log('🚀 Initializing Enhanced Admin Dashboard...');
        window.adminSystem = new AdminDashboardSystem();
        await window.adminSystem.initialize();
        
        // Initialize connection status listener
        if (window.adminSystem?.dataManager?.listenToConnectionStatus) {
          window.adminSystem.dataManager.listenToConnectionStatus(
            document.getElementById('connectionStatus'),
            document.getElementById('connectionText')
          );
        }
      }, null, 'Admin Dashboard Initialization');
    });

    // Handle window resize for chart responsiveness
    window.addEventListener('resize', () => {
      if (window.adminSystem?.charts) {
        clearTimeout(window.resizeTimeout);
        window.resizeTimeout = setTimeout(() => {
          Object.values(window.adminSystem.charts).forEach(chart => {
            if (chart && typeof chart.resize === 'function') {
              chart.resize();
            }
          });
        }, 250);
      }
    });
  </script>
  <div id="studentProfileModal" class="modal-overlay" style="display:none;">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title">Student Profile</h2>
      <button class="modal-close" onclick="document.getElementById('studentProfileModal').style.display='none'">×</button>
    </div>
    <div class="modal-body" id="studentProfileContent">
      <!-- Content will be injected dynamically -->
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="document.getElementById('studentProfileModal').style.display='none'">Close</button>
    </div>
  </div>
</div>
</body>
</html>