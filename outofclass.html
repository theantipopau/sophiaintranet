<!DOCTYPE html>

<html aria-label="Sophia College Out-of-Class Tracker" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>Sophia College Out-of-Class Logger</title>
<link href="logo.ico" rel="icon" type="image/x-icon"/>
<link href="shared/common-styles.css" rel="stylesheet"/>
<link href="css/outofclass-styles.css" rel="stylesheet"/>
<!-- Preload critical assets for better performance -->
<link as="image" href="crest.png" rel="preload"/>
<link as="image" href="sophia-logo.png" rel="preload"/>
<link as="script" href="shared/sophia-unified-system.js" rel="preload"/>
<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/11.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.7.1/firebase-firestore-compat.js"></script>
<!-- PapaParse CSV parser (still included for other potential uses in unified system) -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<!-- Unified Sophia System -->
<script src="shared/sophia-unified-system.js"></script>
<script src="js/critical-fixes.js"></script>
<style>
    :root {
      --bg: linear-gradient(135deg, #fbecec 0%, #f0f4f8 100%);
      --card-bg: #fff;
      --text: #2c2c2c;
      --text-light: #64748b;
      --text-muted: #94a3b8;
      --border: #e2e8f0;
      --border-light: #f1f5f9;
      --shadow: 0 4px 12px rgba(0,0,0,0.08);
      --shadow-hover: 0 8px 25px rgba(0,0,0,0.15);
      --border-radius: 12px;
      --success: #059669;
      --warning: #d97706;
      --error: #dc2626;
      --info: #0284c7;
      --transition: all 0.3s ease;
      --max-width: 1200px;
      --content-padding: 24px;
      --spacing-xs: 4px;
      --spacing-sm: 8px;
      --spacing-md: 16px;
      --spacing-lg: 24px;
      --spacing-xl: 32px;
    }

    body {
      font-family: 'Inter', 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
      font-size: 14px;
    }

    /* Performance-optimized animations */
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Enhanced Loading State */
    .loading-state {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.95);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      backdrop-filter: blur(4px);
    }

    .loading-spinner {
      width: 48px;
      height: 48px;
      border: 3px solid var(--border);
      border-top: 3px solid var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: var(--spacing-lg);
    }

    .loading-text {
      font-size: 1.1em;
      color: var(--nav-bg);
      font-weight: 500;
    }

    /* Main Container */
    .container {
      max-width: var(--max-width);
      margin: 0 auto;
      padding: var(--content-padding);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: var(--spacing-xl);
    }

    /* Enhanced Section Structure */
    .section {
      width: 100%;
      max-width: 1000px;
    }

    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: var(--spacing-lg);
      padding-bottom: var(--spacing-md);
      border-bottom: 2px solid var(--border-light);
    }

    .section-title {
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
      font-size: 1.5em;
      font-weight: 600;
      color: var(--nav-bg);
      margin: 0;
    }

    .section-subtitle {
      color: var(--text-light);
      font-size: 0.9em;
      margin: var(--spacing-xs) 0 0 0;
    }

    /* Header Section */
    .header-section {
      text-align: center;
      padding: var(--spacing-xl);
      background: var(--card-bg);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      animation: fadeInUp 0.6s ease;
      border: 1px solid var(--border);
    }

    .logo-center {
      max-width: 180px;
      margin: 0 auto var(--spacing-lg);
      display: block;
      filter: drop-shadow(0 4px 8px rgba(0,0,0,0.1));
      transition: var(--transition);
    }

    .logo-center:hover {
      transform: scale(1.02);
    }

    .header-title {
      color: var(--nav-bg);
      margin: 0 0 var(--spacing-sm) 0;
      font-size: 2em;
      font-weight: 700;
    }

    .subtitle {
      color: var(--text-light);
      font-size: 1.1em;
      margin: 0;
      font-weight: 400;
    }

    /* Enhanced Status Banner */
    .status-banner {
      padding: var(--spacing-md) var(--spacing-lg);
      border-radius: var(--border-radius);
      margin-bottom: var(--spacing-lg);
      text-align: center;
      font-weight: 500;
      display: none;
      border: 1px solid;
      position: relative;
      overflow: hidden;
    }

    .status-banner::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
      animation: shimmer 2s infinite;
    }

    @keyframes shimmer {
      0% { left: -100%; }
      100% { left: 100%; }
    }

    .banner-loading {
      background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
      border-color: #90caf9;
      color: var(--nav-bg);
    }

    .banner-error {
      background: linear-gradient(135deg, #ffebee 0%, #fce4ec 100%);
      border-color: var(--error);
      color: var(--error);
    }

    .banner-success {
      background: linear-gradient(135deg, #e8f5e8 0%, #f1f8e9 100%);
      border-color: var(--success);
      color: var(--success);
    }

    /* Enhanced Stats Cards */
    .stats-grid {
      display: grid;
      grid-template-columns: 1fr;
      max-width: 250px;
      margin: 0 auto;
      gap: var(--spacing-lg);
      margin-bottom: var(--spacing-xl);
    }

    .stat-card {
      background: var(--card-bg);
      padding: var(--spacing-lg);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      text-align: center;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
      border: 1px solid var(--border);
      cursor: default;
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: var(--accent);
    }

    .stat-card.warning::before { background: var(--warning); }
    .stat-card.success::before { background: var(--success); }
    .stat-card.info::before { background: var(--info); }

    .stat-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-hover);
    }

    .stat-icon {
      font-size: 2em;
      margin-bottom: var(--spacing-sm);
      opacity: 0.8;
    }

    .stat-number {
      font-size: 2.2em;
      font-weight: 700;
      color: var(--accent);
      display: block;
      margin-bottom: var(--spacing-xs);
      line-height: 1;
    }

    .stat-label {
      font-size: 0.9em;
      color: var(--text-light);
      font-weight: 500;
    }

    /* Today's Breakdown Styles */
    .today-analysis-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: var(--spacing-lg);
      margin-top: var(--spacing-lg);
    }

    .analysis-card {
      background: var(--border-light);
      padding: var(--spacing-md);
      border-radius: var(--border-radius);
      border: 1px solid var(--border);
    }

    .analysis-title {
      font-weight: 600;
      color: var(--nav-bg);
      margin: 0 0 var(--spacing-md) 0;
      padding-bottom: var(--spacing-sm);
      border-bottom: 1px solid var(--border);
      font-size: 1.1em;
    }

    .analysis-list {
      list-style: none;
      padding: 0;
      margin: 0;
      font-size: 0.9em;
    }

    .analysis-item {
      display: flex;
      justify-content: space-between;
      padding: var(--spacing-sm) 0;
      border-bottom: 1px solid var(--border);
    }

    .analysis-item:last-child {
      border-bottom: none;
    }

    .analysis-item .name {
      font-weight: 500;
    }

    .analysis-item .count {
      font-weight: 600;
      background: var(--accent);
      color: #fff;
      border-radius: 10px;
      padding: 2px 8px;
      font-size: 0.85em;
    }

    /* Enhanced Form Section */
    .form-section {
      background: var(--card-bg);
      padding: var(--spacing-xl);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: var(--spacing-lg);
      margin-bottom: var(--spacing-xl);
    }

    .control-group {
      display: flex;
      flex-direction: column;
    }

    .control-group label {
      margin-bottom: var(--spacing-sm);
      font-weight: 600;
      color: var(--nav-bg);
      font-size: 0.9em;
      display: flex;
      align-items: center;
      gap: var(--spacing-xs);
    }

    .form-input {
      padding: 14px 16px;
      border: 2px solid var(--border);
      border-radius: 8px;
      font-size: 1em;
      transition: var(--transition);
      background: var(--card-bg);
      font-family: inherit;
      position: relative;
    }

    .form-input:focus {
      border-color: var(--accent);
      outline: none;
      box-shadow: 0 0 0 3px rgba(102,0,0,0.1);
      background: #fff;
    }

    .form-input.valid {
      border-color: var(--success);
      background: #f8fff8;
    }

    .form-input.invalid {
      border-color: var(--error);
      background: #fff8f8;
    }

    .form-input.textarea {
      min-height: 100px;
      resize: vertical;
      font-family: inherit;
    }

    /* Enhanced Student Search */
    .student-search-container {
      position: relative;
    }

    .student-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-top: none;
      border-radius: 0 0 8px 8px;
      max-height: 240px;
      overflow-y: auto;
      z-index: 1000;
      display: none;
      box-shadow: var(--shadow);
    }

    .student-option {
      padding: 14px 16px;
      border-bottom: 1px solid var(--border-light);
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
    }

    .student-option:hover {
      background: var(--border-light);
    }

    .student-option:last-child {
      border-bottom: none;
    }

    .student-option .student-id {
      color: var(--text-light);
      font-size: 0.85em;
      font-weight: 500;
    }

    .student-option .student-house {
      color: var(--accent);
      font-size: 0.8em;
      font-weight: 600;
      background: rgba(102,0,0,0.1);
      padding: 2px 6px;
      border-radius: 4px;
      margin-left: auto;
    }

    /* Enhanced Submit Button */
    .submit-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--spacing-sm);
      margin: 0 auto;
      padding: 16px 32px;
      background: linear-gradient(135deg, var(--accent) 0%, #880000 100%);
      color: #fff;
      border: none;
      border-radius: var(--border-radius);
      font-size: 1.1em;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      box-shadow: var(--shadow);
      min-width: 200px;
      position: relative;
      overflow: hidden;
    }

    .submit-btn:hover:not(:disabled) {
      transform: translateY(-2px);
      background: linear-gradient(135deg, #880000 0%, var(--accent) 100%);
      box-shadow: var(--shadow-hover);
    }

    .submit-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
      background: var(--text-muted);
    }

    .btn-spinner {
      width: 20px;
      height: 20px;
      border: 2px solid rgba(255,255,255,0.3);
      border-top: 2px solid #fff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      display: none;
    }

    .submit-btn.loading .btn-text {
      opacity: 0;
    }
    
    .submit-btn.loading .btn-spinner {
        display: block;
        position: absolute;
    }

    /* Enhanced Student Profile */
    .student-profile {
      background: var(--card-bg);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      overflow: hidden;
      border: 1px solid var(--border);
      opacity: 0;
      transform: translateY(20px);
      transition: var(--transition);
      display: none; /* Hide by default */
    }

    .student-profile.visible {
      opacity: 1;
      transform: translateY(0);
      display: block;
    }

    .profile-header {
      display: flex;
      align-items: center;
      gap: var(--spacing-lg);
      padding: var(--spacing-xl);
      background: linear-gradient(135deg, var(--nav-bg) 0%, #004080 100%);
      color: white;
    }

    .profile-photo {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      overflow: hidden;
      border: 3px solid rgba(255,255,255,0.3);
      background: rgba(255,255,255,0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2em;
      flex-shrink: 0;
    }

    .profile-photo img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .profile-photo .fallback-icon {
        font-size: 2em;
        display: none;
    }

    .profile-details h3 {
      margin: 0 0 var(--spacing-sm) 0;
      font-size: 1.5em;
      font-weight: 600;
    }

    .profile-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: var(--spacing-md);
      padding: var(--spacing-xl);
    }

    .profile-item {
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
      padding: var(--spacing-md);
      background: var(--border-light);
      border-radius: 8px;
      transition: var(--transition);
    }

    .profile-item:hover {
      background: var(--border);
      transform: translateX(4px);
    }

    .profile-item .icon {
      font-size: 1.2em;
      opacity: 0.8;
      width: 24px;
      text-align: center;
    }

    .profile-item .label {
      font-weight: 600;
      color: var(--text-light);
      font-size: 0.85em;
      min-width: 80px;
    }

    .profile-item .value {
      font-weight: 500;
      color: var(--text);
    }

    /* Enhanced History Section */
    .history-section {
      background: var(--card-bg);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
    }

    .history-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--spacing-lg);
      border-bottom: 1px solid var(--border);
      background: var(--border-light);
    }

    .history-title {
      margin: 0;
      font-size: 1.3em;
      font-weight: 600;
      color: var(--nav-bg);
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
    }

    .history-count {
      background: var(--accent);
      color: white;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.85em;
      font-weight: 600;
      min-width: 24px;
      text-align: center;
    }

    .history-list {
      max-height: 400px;
      overflow-y: auto;
    }

    .history-empty {
      text-align: center;
      padding: var(--spacing-xl);
      color: var(--text-muted);
      font-style: italic;
    }

    .history-item {
      padding: var(--spacing-lg);
      border-bottom: 1px solid var(--border-light);
      transition: var(--transition);
      display: grid;
      grid-template-columns: auto 1fr;
      gap: var(--spacing-md);
      align-items: center;
    }

    .history-item:last-child {
      border-bottom: none;
    }

    .history-item:hover {
      background: var(--border-light);
    }

    .history-timestamp {
      font-size: 0.8em;
      color: var(--text-muted);
      font-weight: 500;
    }

    .history-details {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-xs);
    }

    .history-reason {
      font-weight: 600;
      color: var(--text);
    }

    .history-notes {
      font-size: 0.85em;
      color: var(--text-light);
    }
    
    .refresh-btn {
      background: var(--accent);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.85em;
      font-weight: 500;
      transition: var(--transition);
      display: flex;
      align-items: center;
      gap: var(--spacing-xs);
    }

    .refresh-btn:hover {
      background: #880000;
      transform: translateY(-1px);
    }
    
    .refresh-btn:disabled {
        cursor: not-allowed;
        opacity: 0.7;
    }
    
    /* Enhanced Toast Notifications */
    .toast {
      position: fixed;
      top: 80px;
      right: var(--spacing-lg);
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: var(--border-radius);
      padding: var(--spacing-md) var(--spacing-lg);
      box-shadow: var(--shadow-hover);
      display: none;
      z-index: 10000;
      max-width: 400px;
      transform: translateX(450px);
      transition: var(--transition);
      border-left: 4px solid var(--info);
    }

    .toast.show {
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
      transform: translateX(0);
    }

    .toast.success { border-left-color: var(--success); }
    .toast.error { border-left-color: var(--error); }
    .toast.warning { border-left-color: var(--warning); }

    .toast-close {
      background: none;
      border: none;
      font-size: 1.2em;
      cursor: pointer;
      opacity: 0.7;
      margin-left: auto;
      padding: 0;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .toast-close:hover {
      opacity: 1;
    }

    /* Footer */
    .footer {
      text-align: center;
      font-size: 0.9em;
      color: var(--text-muted);
      margin-top: var(--spacing-xl);
      padding: var(--spacing-xl);
      border-top: 1px solid var(--border);
    }

    .footer a {
      color: var(--nav-bg);
      text-decoration: none;
      font-weight: 500;
      margin: 0 var(--spacing-sm);
      transition: var(--transition);
    }

    .footer a:hover {
      color: var(--accent);
      text-decoration: underline;
    }

    /* Validation Message Styles */
    .validation-message {
      padding: 6px 12px;
      border-radius: 4px;
      font-size: 0.8em;
      margin-top: 6px;
      display: none;
      animation: slideIn 0.3s ease;
    }

    .validation-message.error {
      background: rgba(220, 38, 38, 0.1);
      border: 1px solid rgba(220, 38, 38, 0.3);
      color: #dc2626;
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateY(-8px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Dark Mode Support */
    .dark-mode {
      --bg: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
      --card-bg: #2d2d2d;
      --text: #e0e0e0;
      --text-light: #a0a0a0;
      --text-muted: #808080;
      --border: #404040;
      --border-light: #353535;
      --shadow: 0 4px 12px rgba(0,0,0,0.3);
      --shadow-hover: 0 8px 25px rgba(0,0,0,0.4);
    }

    .dark-mode .form-input {
      background: #404040;
      border-color: #555;
      color: #e0e0e0;
    }

    .dark-mode .form-input:focus {
      background: #4a4a4a;
    }

    .dark-mode .student-dropdown {
      background: #404040;
      border-color: #555;
    }

    .dark-mode .student-option:hover {
      background: #4a4a4a;
    }
    
    .dark-mode .analysis-card {
      background: #353535;
      border-color: #404040;
    }
    
    .dark-mode .analysis-title {
        border-color: #404040;
    }

    .dark-mode .analysis-item {
        border-color: #404040;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      :root {
        --content-padding: 16px;
        --spacing-xl: 24px;
      }

      .nav-bar {
        padding: 10px 16px;
      }

      .nav-title {
        font-size: 1.1em;
      }

      .container {
        padding: 16px;
        gap: var(--spacing-lg);
      }

      .header-section,
      .form-section,
      .student-profile,
      .history-section,
      .active-incidents-section {
        padding: var(--spacing-lg);
      }

      .header-title {
        font-size: 1.6em;
      }

      .form-grid {
        grid-template-columns: 1fr;
        gap: var(--spacing-md);
      }

      .profile-header {
        flex-direction: column;
        text-align: center;
        gap: var(--spacing-md);
      }

      .profile-grid {
        grid-template-columns: 1fr;
      }

      .stats-grid {
        grid-template-columns: 1fr;
        gap: var(--spacing-md);
      }

      #staffName {
        display: none;
      }

      .toast {
        right: var(--spacing-md);
        left: var(--spacing-md);
        max-width: none;
        transform: translateY(-100px);
      }

      .toast.show {
        transform: translateY(0);
      }
    }

    @media (max-width: 480px) {
      .submit-btn {
        width: 100%;
        max-width: 280px;
      }

      .section-header {
        flex-direction: column;
        align-items: flex-start;
        gap: var(--spacing-sm);
      }
    }

    /* Accessibility Improvements */
    *:focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }

    /* Reduced motion support */
    @media (prefers-reduced-motion: reduce) {
      * {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }
  </style>
</head>
<body>
<!-- Skip to main content for accessibility -->
<a class="skip-link" href="#main-content">Skip to main content</a>
<!-- Enhanced Loading State -->
<div aria-label="Loading system" class="loading-state" id="loadingState" role="status">
<div aria-hidden="true" class="loading-spinner"></div>
<div class="loading-text">Loading Out-of-Class Logger...</div>
</div>
<!-- Enhanced Navigation -->
<nav aria-label="Main navigation" class="nav-bar" role="navigation">
<div class="nav-left">
<img alt="College Crest" class="nav-logo" src="crest.png"/>
</div>
<div class="nav-title">üè´ Out-of-Class Logger</div>
<div class="nav-right">
<div class="nav-links">
<span aria-live="polite" id="staffName"></span>
<button aria-label="Toggle dark mode" class="theme-btn" id="themeToggle" title="Toggle dark mode">üåì</button>
<div class="dropdown">
<button aria-expanded="false" aria-haspopup="true" aria-label="Navigation menu" class="dropbtn">
            ‚ò∞ Menu
          </button>
<div class="dropdown-content" role="menu">
<a href="home.html" onclick="navigate('home.html'); return false;" role="menuitem">üè† Home</a>
<a href="staff.html" onclick="navigate('staff.html'); return false;" role="menuitem">üìù Infringement Tracker</a>
<a href="outofclass.html" onclick="navigate('outofclass.html'); return false;" role="menuitem">üè´ Out-of-Class Logger</a>
<a href="positiveaffirmations.html" onclick="navigate('positiveaffirmations.html'); return false;" role="menuitem">‚ú® Positive Affirmations</a>
<a href="reengagementroom.html" onclick="navigate('reengagementroom.html'); return false;" role="menuitem">üîÑ Re-Engagement Room</a>
<a href="admin.html" id="adminLink" onclick="navigate('admin.html'); return false;" role="menuitem">
              üë• Admin Dashboard 
              <span aria-label="notifications" class="badge" id="badge" style="display:none;"></span>
</a>
<button onclick="logout(); return false;" role="menuitem">üö™ Logout</button>
</div>
</div>
</div>
</div>
</nav>
<!-- Main Container -->
<main class="container" id="main-content" style="display: none;">
<!-- Enhanced Status Banner -->
<div class="status-banner banner-loading" id="statusBanner">
<div id="statusText">üîÑ Initializing system and loading data...</div>
</div>
<!-- Header Section -->
<section class="section">
<div class="header-section">
<img alt="Sophia College" class="logo-center" src="sophia-logo.png"/>
<h1 class="header-title">Out-of-Class Logger</h1>
<p class="subtitle">Quickly log when a student leaves the classroom</p>
</div>
</section>
<!-- Today's Breakdown Section -->
<section class="section" id="statsSection" style="display: none;">
<div class="section-header">
<div>
<h2 class="section-title">üìä Today's Breakdown</h2>
<p class="section-subtitle">A real-time overview of today's logs and patterns</p>
</div>
<button aria-label="Refresh statistics" class="refresh-btn" onclick="refreshStats()">
          üîÑ Refresh
        </button>
</div>
<div class="stats-grid" id="statsGrid">
<div class="stat-card warning" id="todayLogsCard">
<div class="stat-icon">üìù</div>
<span class="stat-number" id="todayLogs">0</span>
<div class="stat-label">Today's Logs</div>
</div>
</div>
<div class="today-analysis-grid">
<div class="analysis-card" id="topReasons">
<h4 class="analysis-title">Top Reasons Today</h4>
<ul class="analysis-list" id="topReasonsList">
<li style="text-align:center; color: var(--text-muted)">Loading...</li>
</ul>
</div>
<div class="analysis-card" id="repeatLogs">
<h4 class="analysis-title">Repeat Logs Today</h4>
<ul class="analysis-list" id="repeatLogsList">
<li style="text-align:center; color: var(--text-muted)">Loading...</li>
</ul>
</div>
</div>
</section>
<!-- Enhanced Form Section -->
<section class="section">
<div class="form-section">
<div class="section-header">
<div>
<h3 class="section-title">üìù Log a Student</h3>
<p class="section-subtitle">Record a student leaving the class</p>
</div>
</div>
<form id="incidentForm" novalidate="">
<div class="form-grid">
<div class="control-group student-search-container">
<label for="searchInput">üîç Search Student</label>
<input aria-describedby="searchHelp" autocomplete="off" class="form-input" id="searchInput" placeholder="Type student name or ID..." required="" type="text"/>
<div class="sr-only" id="searchHelp">Start typing to search for students by name or ID</div>
<div aria-label="Student search results" class="student-dropdown" id="studentDropdown" role="listbox"></div>
<input id="selectedStudentId" type="hidden"/>
</div>
<div class="control-group">
<label for="reasonSelect">üìã Reason for Leaving</label>
<select aria-label="Select reason for leaving class" class="form-input" id="reasonSelect" required="">
<option value="">Loading reasons...</option>
</select>
</div>
<div class="control-group">
<label for="detailsInput">üìù Additional Details</label>
<textarea aria-label="Additional details about the incident" class="form-input textarea" id="detailsInput" placeholder="Add any additional notes or context..." rows="4"></textarea>
</div>
</div>
<button aria-describedby="submitHelp" class="submit-btn" disabled="" id="logBtn" type="submit">
<span class="btn-text">Complete Form to Continue</span>
<div aria-hidden="true" class="btn-spinner"></div>
</button>
<div class="sr-only" id="submitHelp">Complete all required fields to enable submission</div>
</form>
</div>
</section>
<!-- Enhanced Student Profile -->
<section class="section">
<div aria-labelledby="profile-title" class="student-profile" id="studentProfile">
<div class="profile-header">
<div class="profile-photo">
<img alt="Student Photo" id="studentPhoto" src=""/>
<div class="fallback-icon">üë§</div>
</div>
<div class="profile-details">
<h3 id="profile-title">Student Profile</h3>
<p style="margin: 0; opacity: 0.9; font-size: 0.9em;">View comprehensive student information and history</p>
</div>
</div>
<div class="profile-grid">
<div class="profile-item">
<span class="icon">üë§</span>
<span class="label">Name:</span>
<span class="value" id="studentNameDetail">-</span>
</div>
<div class="profile-item">
<span class="icon">üÜî</span>
<span class="label">BCE ID:</span>
<span class="value" id="studentBCE">-</span>
</div>
<div class="profile-item">
<span class="icon">üè†</span>
<span class="label">House:</span>
<span class="value" id="studentHouse">-</span>
</div>
<div class="profile-item">
<span class="icon">üè´</span>
<span class="label">Home Group:</span>
<span class="value" id="studentHomeGroup">-</span>
</div>
<div class="profile-item">
<span class="icon">üìä</span>
<span class="label">Year Level:</span>
<span class="value" id="studentYear">-</span>
</div>
<div class="profile-item">
<span class="icon">üìà</span>
<span class="label">Total Logs:</span>
<span class="value" id="studentLogCount">-</span>
</div>
</div>
</div>
</section>
<!-- Enhanced History Section -->
<section class="section">
<div aria-labelledby="history-title" class="history-section" id="historySection">
<div class="history-header">
<h3 class="history-title" id="history-title">üìú Previous Logs</h3>
<span aria-label="Number of previous logs" class="history-count" id="historyCount">0</span>
</div>
<div aria-live="polite" class="history-list" id="historyList" role="log">
<div class="history-empty">
            Select a student to view their history
          </div>
</div>
</div>
</section>
</main>
<!-- Enhanced Toast Notifications -->
<div aria-live="assertive" class="toast" id="toast" role="alert">
<span id="toastMessage"></span>
<button aria-label="Close notification" class="toast-close" onclick="hideToast()">√ó</button>
</div>
<!-- Footer -->
<footer class="footer">
<div>
      ¬© 2025 Sophia College ¬∑ 
      <a href="https://www.sophiacollege.qld.edu.au/">College Homepage</a> ¬∑  
      <a href="mailto:splaittech@bne.catholic.edu.au">IT Support</a>
</div>
</footer>
<script>
    'use strict';
    
    // --- GLOBAL STATE & CONFIGURATION ---
    let sophiaSystem;
    let studentData = [];
    let selectedStudent = null;
    let searchSystem, studentProfileManager, formValidationManager, dataManager;

    // --- Student Photo Path ---
    const STUDENT_PHOTO_PATH_TEMPLATE = '/students/{id}.jpg';

    // --- INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', async () => {
        try {
            updateStatus('üîÑ Initializing system...', 'loading');
            
            await waitForSophiaSystem();
            sophiaSystem = window.SophiaSystem;
            await window.SophiaSystem.initializeSystem('outofclass');

            // Initialize managers AFTER DOM is ready
            searchSystem = new OptimizedOutOfClassSearch();
            studentProfileManager = new StudentProfileManager();
            dataManager = new OptimizedDataManager();
            
            // Setup new unified validator
            formValidationManager = new UnifiedFormValidator('incidentForm');
            formValidationManager.addRule('searchInput', (value) => document.getElementById('selectedStudentId').value !== '', 'Please select a student');
            formValidationManager.addRule('reasonSelect', (value) => value !== '', 'Please select a reason');
            
            // Make them globally available
            window.searchSystem = searchSystem;
            window.studentProfileManager = studentProfileManager;
            window.formValidationManager = formValidationManager;
            window.dataManager = dataManager;

            updateStatus('‚úÖ System ready!', 'success');
            
            setTimeout(() => {
                hideStatusBanner();
                showMainInterface();
                setupUI();
                loadInitialData();
            }, 500);
            
        } catch (error) {
            console.error('‚ùå Initialization failed:', error);
            updateStatus('‚ùå System initialization failed. Please refresh.', 'error');
            const loadingState = document.getElementById('loadingState');
            if(loadingState) loadingState.style.display = 'none';
        }
    });

    async function waitForSophiaSystem() {
        return new Promise((resolve, reject) => {
            let attempts = 0;
            const interval = setInterval(() => {
                if (window.SophiaSystem && typeof window.SophiaSystem.initializeSystem === 'function') {
                    clearInterval(interval);
                    resolve();
                } else if (attempts > 20) {
                    clearInterval(interval);
                    reject(new Error('Sophia Unified System failed to load.'));
                }
                attempts++;
            }, 250);
        });
    }

    async function loadInitialData() {
        if (sophiaSystem && sophiaSystem.module && sophiaSystem.module.students) {
            studentData = sophiaSystem.module.students;
            console.log('‚úÖ Loaded', studentData.length, 'students');
        } else {
            showToast('Student data not loaded from unified system.', 'warning');
        }
        refreshStats();
    }

    // --- UI SETUP & CONTROLS ---
    function setupUI() {
        document.getElementById('themeToggle')?.addEventListener('click', () => {
            document.body.classList.toggle('dark-mode');
            localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
        });
        if (localStorage.getItem('darkMode') === 'true') {
            document.body.classList.add('dark-mode');
        }

        const staffInfo = JSON.parse(localStorage.getItem('loggedInStaff') || '{}');
        const staffNameEl = document.getElementById('staffName');
        if (staffNameEl && staffInfo['staff name']) staffNameEl.textContent = staffInfo['staff name'];

        document.getElementById('incidentForm')?.addEventListener('submit', handleFormSubmit);
    }

    function showMainInterface() {
        const loadingState = document.getElementById('loadingState');
        const navBar = document.getElementById('navBar');
        const mainContent = document.getElementById('main-content');
        const statsSection = document.getElementById('statsSection');

        if (loadingState) loadingState.style.display = 'none';
        if (navBar) {
            navBar.style.display = 'flex';
            navBar.style.animation = 'fadeIn 0.5s ease';
        }
        if (mainContent) {
            mainContent.style.display = 'flex';
            mainContent.style.animation = 'fadeInUp 0.6s ease';
        }
        if (statsSection) {
            statsSection.style.display = 'block';
        }
    }

    // --- FIXED STUDENT SEARCH SYSTEM ---
    class OptimizedOutOfClassSearch {
      constructor() {
        this.searchCache = new Map();
        this.searchResults = [];
        this.selectedStudent = null;
        
        // Ensure DOM is ready
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', () => this.initialize());
        } else {
          this.initialize();
        }
      }

      initialize() {
        console.log('üîç Initializing search system...');
        
        // Cache DOM elements
        this.dom = {
          searchInput: document.getElementById('searchInput'),
          dropdown: document.getElementById('studentDropdown'),
          hiddenInput: document.getElementById('selectedStudentId'),
          profile: document.getElementById('studentProfile')
        };
        
        // Verify DOM elements exist
        const missing = Object.entries(this.dom).filter(([key, el]) => !el).map(([key]) => key);
        if (missing.length > 0) {
          console.error('‚ùå Missing DOM elements:', missing);
          return;
        }
        
        console.log('‚úÖ All DOM elements found');
        this.setupEvents();
      }

      setupEvents() {
        const debouncedSearch = this.debounce(this.performSearch.bind(this), 250);
        
        this.dom.searchInput.addEventListener('input', (e) => {
          const query = e.target.value.trim();
          console.log('üîç Search input:', query);
          debouncedSearch(query);
        });

        this.dom.searchInput.addEventListener('keydown', (e) => {
          this.handleKeyNavigation(e);
        });

        // Close dropdown on outside click
        document.addEventListener('click', (e) => {
          if (!this.dom.searchInput.contains(e.target) && 
              !this.dom.dropdown.contains(e.target)) {
            this.hideDropdown();
          }
        });
        
        console.log('‚úÖ Search events setup complete');
      }

      debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
          const later = () => {
            clearTimeout(timeout);
            func(...args);
          };
          clearTimeout(timeout);
          timeout = setTimeout(later, wait);
        };
      }

      performSearch(query) {
        console.log('üîç Performing search for:', query);
        
        if (query.length < 2) {
          this.hideDropdown();
          return;
        }

        // Check cache first
        const cacheKey = query.toLowerCase();
        if (this.searchCache.has(cacheKey)) {
          console.log('üìã Using cached results');
          this.displayResults(this.searchCache.get(cacheKey));
          return;
        }

        // Perform search
        const results = studentData.filter(student => {
          const fullName = `${student.FirstName} ${student.LegalSurname1}`.toLowerCase();
          const bceid = student.BCEID1?.toLowerCase() || '';
          return fullName.includes(cacheKey) || bceid.includes(cacheKey);
        }).slice(0, 8);

        console.log('üîç Found', results.length, 'results for:', query);
        
        // Cache results
        this.searchCache.set(cacheKey, results);
        this.displayResults(results);
      }

      displayResults(results) {
        this.searchResults = results;
        this.dom.dropdown.innerHTML = '';

        if (results.length === 0) {
          this.dom.dropdown.innerHTML = `
            <div class="student-option no-results">
              <span>üîç No students found</span>
            </div>`;
        } else {
          results.forEach((student, index) => {
            const option = document.createElement('div');
            option.className = 'student-option';
            option.setAttribute('data-index', index);
            option.setAttribute('role', 'option');
            option.setAttribute('tabindex', '0');
            
            option.innerHTML = `
              <div class="student-info">
                <strong>${student.FirstName} ${student.LegalSurname1}</strong>
                <div class="student-id">${student.BCEID1}</div>
              </div>
              <div class="student-meta">
                <span class="student-house">${student.HouseName || 'N/A'}</span>
              </div>`;
            
            // Fixed event handler
            option.addEventListener('click', (event) => {
              event.preventDefault();
              event.stopPropagation();
              console.log('üëÜ Student clicked:', student.FirstName, student.LegalSurname1);
              this.selectStudent(index);
            });
            
            this.dom.dropdown.appendChild(option);
          });
        }

        this.showDropdown();
      }

      selectStudent(index) {
        console.log('‚úÖ Selecting student at index:', index);
        
        if (!this.searchResults[index]) {
          console.error('‚ùå Student not found at index:', index);
          return;
        }

        this.selectedStudent = this.searchResults[index];
        selectedStudent = this.selectedStudent; // Update global
        
        const fullName = `${this.selectedStudent.FirstName} ${this.selectedStudent.LegalSurname1}`;
        
        console.log('üìù Updating UI for:', fullName);
        
        // Update search input
        this.dom.searchInput.value = fullName;
        
        // Update hidden input
        this.dom.hiddenInput.value = this.selectedStudent.BCEID1;
        
        console.log('‚úÖ Hidden input value set to:', this.dom.hiddenInput.value);
        
        this.hideDropdown();
        
        // Show profile
        if (window.studentProfileManager) {
          window.studentProfileManager.showProfile(this.selectedStudent);
        }
        
        // Force form validation
        if (formValidationManager) {
          setTimeout(() => {
            console.log('üîÑ Triggering form validation...');
            formValidationManager.validateForm();
          }, 100);
        }
        
        showToast(`‚úÖ Selected ${fullName}`, 'success', 2000);
      }

      handleKeyNavigation(e) {
        if (!this.dom.dropdown.style.display === 'block') return;
        
        const options = this.dom.dropdown.querySelectorAll('.student-option:not(.no-results)');
        if (options.length === 0) return;
        
        const currentFocus = this.dom.dropdown.querySelector('.student-option.focused');
        let index = currentFocus ? Array.from(options).indexOf(currentFocus) : -1;

        switch (e.key) {
          case 'ArrowDown':
            e.preventDefault();
            index = Math.min(index + 1, options.length - 1);
            this.focusOption(options, index);
            break;
          case 'ArrowUp':
            e.preventDefault();
            index = Math.max(index - 1, 0);
            this.focusOption(options, index);
            break;
          case 'Enter':
            e.preventDefault();
            if (currentFocus) {
              const studentIndex = parseInt(currentFocus.dataset.index);
              this.selectStudent(studentIndex);
            }
            break;
          case 'Escape':
            this.hideDropdown();
            break;
        }
      }

      focusOption(options, index) {
        options.forEach(opt => opt.classList.remove('focused'));
        if (options[index]) {
          options[index].classList.add('focused');
          options[index].scrollIntoView({ block: 'nearest' });
        }
      }

      showDropdown() {
        this.dom.dropdown.style.display = 'block';
        this.dom.dropdown.setAttribute('aria-expanded', 'true');
      }

      hideDropdown() {
        this.dom.dropdown.style.display = 'none';
        this.dom.dropdown.setAttribute('aria-expanded', 'false');
      }
    }

    // The FormValidationManager class has been removed and is now handled by
    // the UnifiedFormValidator in js/critical-fixes.js

    // --- STUDENT PROFILE MANAGER ---
    class StudentProfileManager {
      constructor() {
        this.currentStudent = null;
        this.profileCache = new Map();
      }

      async showProfile(student) {
        if (!student) return;
        
        this.currentStudent = student;
        const profile = document.getElementById('studentProfile');
        if (!profile) return;

        try {
          const profileData = await this.getProfileData(student);
          await this.animateProfileUpdate(profileData);
          await this.loadStudentHistory(student);
        } catch (error) {
          console.error('Error loading profile:', error);
          showToast('Failed to load student profile', 'error');
        }
      }

      async getProfileData(student) {
        const cacheKey = student.BCEID1;
        
        if (this.profileCache.has(cacheKey)) {
          return this.profileCache.get(cacheKey);
        }

        const possibleYearFields = [
          'YearLevelName', 'YearLevel', 'Year', 'year', 'YearGroup', 
          'yeargroup', 'Grade', 'grade', 'Level', 'level'
        ];

        let yearValue = 'Unknown';
        for (const field of possibleYearFields) {
          if (student[field] && student[field] !== '') {
            yearValue = student[field];
            break;
          }
        }

        const profileData = {
          name: `${student.FirstName} ${student.LegalSurname1}`,
          bceid: student.BCEID1,
          house: student.HouseName || 'N/A',
          homeGroup: student.HomeGroup || 'N/A',
          year: yearValue,
          photoUrl: this.getPhotoUrl(student.BCEID1)
        };

        this.profileCache.set(cacheKey, profileData);
        return profileData;
      }

      getPhotoUrl(bceid) {
        const finalPhotoId = bceid.toLowerCase().startsWith('s') ? bceid : `s${bceid}`;
        return STUDENT_PHOTO_PATH_TEMPLATE.replace('{id}', finalPhotoId);
      }

      async animateProfileUpdate(profileData) {
        const profile = document.getElementById('studentProfile');
        if (!profile) return;

        const newContent = `
          <div class="profile-header">
            <div class="profile-photo">
              <img id="studentPhoto" alt="Student Photo" src="${profileData.photoUrl}">
              <div class="fallback-icon">üë§</div>
            </div>
            <div class="profile-details">
              <h3 id="profile-title">${profileData.name}</h3>
              <p style="margin: 0; opacity: 0.9; font-size: 0.9em;">Student Profile & History</p>
            </div>
          </div>
          <div class="profile-grid">
            <div class="profile-item">
              <span class="icon">üë§</span>
              <span class="label">Name:</span>
              <span class="value">${profileData.name}</span>
            </div>
            <div class="profile-item">
              <span class="icon">üÜî</span>
              <span class="label">BCE ID:</span>
              <span class="value">${profileData.bceid}</span>
            </div>
            <div class="profile-item">
              <span class="icon">üè†</span>
              <span class="label">House:</span>
              <span class="value">${profileData.house}</span>
            </div>
            <div class="profile-item">
              <span class="icon">üè´</span>
              <span class="label">Home Group:</span>
              <span class="value">${profileData.homeGroup}</span>
            </div>
            <div class="profile-item">
              <span class="icon">üìä</span>
              <span class="label">Year Level:</span>
              <span class="value">${profileData.year}</span>
            </div>
            <div class="profile-item">
              <span class="icon">üìà</span>
              <span class="label">Total Logs:</span>
              <span class="value" id="studentLogCount">Loading...</span>
            </div>
          </div>
        `;

        profile.innerHTML = newContent;
        profile.classList.add('visible');
        
        // Handle photo loading
        const photo = document.getElementById('studentPhoto');
        const fallback = photo.nextElementSibling;
        
        photo.onload = () => {
          photo.style.display = 'block';
          fallback.style.display = 'none';
        };
        
        photo.onerror = () => {
          photo.style.display = 'none';
          fallback.style.display = 'flex';
        };
      }

      async loadStudentHistory(student) {
        const historyList = document.getElementById('historyList');
        const historyCount = document.getElementById('historyCount');
        if (!historyList || !historyCount) return;

        try {
            const historyData = await window.dataManager.getStudentHistory(student.BCEID1);
            
            const count = historyData.length;
            historyCount.textContent = count;
            document.getElementById('studentLogCount').textContent = count;

            if (count === 0) {
                historyList.innerHTML = `
                  <div class="history-empty">
                    <div style="font-size: 2em; margin-bottom: 8px;">üìù</div>
                    <div>No logs found for this student</div>
                  </div>`;
                return;
            }
            
            const historyItems = historyData.map((log, index) => {
                const timestamp = log.timestamp;
                return `
                  <div class="history-item">
                    <div class="history-timestamp">
                      ${timestamp.toLocaleDateString()} 
                      ${timestamp.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                    </div>
                    <div class="history-details">
                      <div class="history-reason">${log.reason || 'N/A'}</div>
                      ${log.details ? `<div class="history-notes">${log.details}</div>` : ''}
                ${log.staff || log.submittedBy ? `
                    <div style="font-size:0.75em;color:var(--text-muted);margin-top:4px;">
                        By: ${log.staff || log.submittedBy}
                    </div>` : ''}
                    </div>
                  </div>`;
            }).join('');

            historyList.innerHTML = historyItems;

        } catch (error) {
            console.error('Error loading history:', error);
            historyList.innerHTML = `
                <div class="history-empty" style="color:var(--error)">
                  <div style="font-size: 2em; margin-bottom: 8px;">‚ö†Ô∏è</div>
                  <div>Error loading history</div>
                </div>`;
        }
      }
    }

    // --- DATA MANAGER ---
    class OptimizedDataManager {
      constructor() {
        this.cache = new Map();
        this.cacheTimeout = 5 * 60 * 1000; // 5 minutes
      }

      async submitLog(data) {
        const batch = firebase.firestore().batch();
        const docRef = firebase.firestore().collection('outofclass').doc();
        
        const optimizedData = {
          ...data,
          timestamp: firebase.firestore.FieldValue.serverTimestamp(),
          submissionId: this.generateSubmissionId()
        };

        batch.set(docRef, optimizedData);
        
        try {
          await batch.commit();
          this.invalidateCache(`student_${data.student}`);
          this.invalidateCache('todayStats');
          return docRef.id;
        } catch (error) {
          console.error('Batch write failed:', error);
          throw error;
        }
      }

      async getTodayStats() {
        const cacheKey = 'todayStats';
        const cached = this.cache.get(cacheKey);
        
        if (cached && Date.now() - cached.timestamp < this.cacheTimeout) {
          return cached.data;
        }

        try {
          const today = new Date();
          today.setHours(0, 0, 0, 0);
          
          const snapshot = await firebase.firestore()
            .collection('outofclass')
            .where('timestamp', '>=', today)
            .orderBy('timestamp', 'desc')
            .limit(100)
            .get();

          const data = this.processStatsData(snapshot);
          this.cache.set(cacheKey, { data, timestamp: Date.now() });
          
          return data;
        } catch (error) {
          console.error('Error loading stats:', error);
          return { count: 0, reasons: {}, repeats: {} };
        }
      }

      async getStudentHistory(studentId, limit = 15) {
        const cacheKey = `student_${studentId}`;
        const cached = this.cache.get(cacheKey);
        
        if (cached && Date.now() - cached.timestamp < this.cacheTimeout) {
          return cached.data;
        }

        try {
          const possibleFields = ['student', 'studentBCEID', 'BCEID', 'studentId'];
          const studentIdVariants = [
            studentId,
            studentId.toLowerCase().startsWith('s') ? studentId.substring(1) : `s${studentId}`,
          ];
          
          for (const field of possibleFields) {
            for (const idVariant of studentIdVariants) {
              try {
                const snapshot = await firebase.firestore()
                  .collection('outofclass')
                  .where(field, '==', idVariant)
                  .orderBy('timestamp', 'desc')
                  .limit(limit)
                  .get();

                if (snapshot.size > 0) {
                  const data = snapshot.docs.map(doc => {
                    const docData = doc.data();
                    return {
                      id: doc.id,
                      ...docData,
                      timestamp: docData.timestamp?.toDate() || new Date()
                    };
                  });

                  this.cache.set(cacheKey, { data, timestamp: Date.now() });
                  return data;
                }
              } catch (queryError) {
                console.log(`Query failed for ${field}:`, queryError.message);
              }
            }
          }
          
          return [];
        } catch (error) {
          console.error('Error loading student history:', error);
          return [];
        }
      }

      processStatsData(snapshot) {
        const reasonCounts = {};
        const studentCounts = {};
        
        snapshot.docs.forEach(doc => {
          const data = doc.data();
          if (data.reason) {
            reasonCounts[data.reason] = (reasonCounts[data.reason] || 0) + 1;
          }
          if (data.studentName) {
            studentCounts[data.studentName] = (studentCounts[data.studentName] || 0) + 1;
          }
        });

        return {
          count: snapshot.size,
          reasons: reasonCounts,
          repeats: Object.fromEntries(
            Object.entries(studentCounts).filter(([, count]) => count > 1)
          )
        };
      }

      invalidateCache(key) {
        if (key) {
          this.cache.delete(key);
        } else {
          this.cache.clear();
        }
      }

      generateSubmissionId() {
        return `${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
      }
    }

    // --- FORM SUBMISSION ---
    async function handleFormSubmit(e) {
        e.preventDefault();
        if (!formValidationManager.validateForm()) {
            showToast('Please fill out all required fields.', 'warning');
            return;
        }

        const logBtn = document.getElementById('logBtn');
        logBtn.classList.add('loading');
        logBtn.disabled = true;

        await ErrorHandler.safeAsync(async () => {
            const staffInfo = JSON.parse(localStorage.getItem('loggedInStaff') || '{}');
            const incidentData = {
                student: selectedStudent.BCEID1,
                studentName: `${selectedStudent.FirstName} ${selectedStudent.LegalSurname1}`,
                reason: document.getElementById('reasonSelect').value,
                details: document.getElementById('detailsInput').value,
                status: 'logged',
                house: selectedStudent.HouseName || '',
                yearLevel: selectedStudent.YearLevelName || '',
                staff: staffInfo['staff name'] || 'Unknown Staff',
                staffName: staffInfo['staff name'] || 'Unknown Staff',
                staffEmail: staffInfo['email'] || 'unknown@example.com'
            };

            await dataManager.submitLog(incidentData);
            showToast('‚úÖ Movement logged successfully!', 'success');
            resetForm();
            await refreshStats();
        }, null, 'Submitting Log');

        logBtn.classList.remove('loading');
        formValidationManager.validateForm(); // Re-validate to reset button state
    }

    // --- UTILITY FUNCTIONS ---
    async function refreshStats() {
        const btn = document.querySelector('#statsSection .refresh-btn');
        if (btn) btn.disabled = true;

        try {
            const stats = await window.dataManager.getTodayStats();
            document.getElementById('todayLogs').textContent = stats.count;
            displayTopReasons(stats.reasons);
            displayRepeatLogs(stats.repeats);
        } catch (err) {
            console.error("Error refreshing stats", err);
            showToast("Could not refresh statistics.", "error");
        } finally {
            if (btn) btn.disabled = false;
        }
    }
    
    function displayTopReasons(counts) {
        const list = document.getElementById('topReasonsList');
        const sorted = Object.entries(counts).sort((a, b) => b[1] - a[1]).slice(0, 3);
        
        if (sorted.length === 0) {
            list.innerHTML = `<li style="text-align:center; color: var(--text-muted)">No reasons logged yet today.</li>`;
            return;
        }
        
        list.innerHTML = sorted.map(([reason, count]) => `
            <li class="analysis-item">
                <span class="name">${reason}</span>
                <span class="count">${count}</span>
            </li>`).join('');
    }

    function displayRepeatLogs(counts) {
        const list = document.getElementById('repeatLogsList');
        const repeats = Object.entries(counts).filter(([name, count]) => count > 1).sort((a,b) => b[1] - a[1]).slice(0, 3);

        if (repeats.length === 0) {
            list.innerHTML = `<li style="text-align:center; color: var(--text-muted)">No repeat logs today.</li>`;
            return;
        }
        
        list.innerHTML = repeats.map(([name, count]) => `
            <li class="analysis-item">
                <span class="name">${name}</span>
                <span class="count">${count}</span>
            </li>`).join('');
    }

    function resetForm() {
        document.getElementById('incidentForm')?.reset();
        document.getElementById('selectedStudentId').value = '';
        
        if (searchSystem) {
            searchSystem.selectedStudent = null;
        }
        selectedStudent = null;
        
        const searchInput = document.getElementById('searchInput');
        if (searchInput) {
            searchInput.classList.remove('field-valid', 'field-invalid');
        }
        
        const profile = document.getElementById('studentProfile');
        if (profile) {
            profile.classList.remove('visible');
        }
        
        const historyList = document.getElementById('historyList');
        if (historyList) {
            historyList.innerHTML = '<div class="history-empty">Select a student to view their history</div>';
        }
        
        const historyCount = document.getElementById('historyCount');
        if (historyCount) {
            historyCount.textContent = '0';
        }
        
        if (formValidationManager) {
            formValidationManager.validateForm();
        }
    }
    
    function updateStatus(message, type) {
        const banner = document.getElementById('statusBanner');
        const text = document.getElementById('statusText');
        if (banner && text) {
            text.textContent = message;
            banner.className = `status-banner banner-${type}`;
            banner.style.display = 'block';
        }
    }

    function hideStatusBanner() {
        const banner = document.getElementById('statusBanner');
        if (banner) {
            banner.style.opacity = '0';
            setTimeout(() => { banner.style.display = 'none'; }, 300);
        }
    }

    // The old showToast and hideToast functions have been removed.
    // The new UnifiedToast system is now active via critical-fixes.js.
    window.navigate = (url) => window.location.href = url;
    window.logout = () => {
        localStorage.clear();
        showToast('üëã Logged out successfully', 'info');
        setTimeout(() => navigate('index.html'), 1000);
    };

    document.addEventListener('DOMContentLoaded', function() {
        // Apply performance optimizations immediately
        PerformanceOptimizer.addCriticalCSS();
        
        // Initialize toast system
        UnifiedToast.init();
        
        // Add global error handling
        window.onerror = function(msg, url, lineNo, columnNo, error) {
            ErrorHandler.showUserFriendlyError(error, 'Global Error');
            return false;
        };
        
        window.addEventListener('unhandledrejection', function(event) {
            ErrorHandler.showUserFriendlyError(event.reason, 'Promise Rejection');
            event.preventDefault();
        });
        
        console.log('‚úÖ Critical fixes applied successfully');
    });
  </script>
</body>
</html>
