<!DOCTYPE html>
<html lang="en" aria-label="Sophia College Positive Affirmations">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Sophia College - Positive Affirmations</title>
  <link rel="stylesheet" href="shared/common-styles.css">
  <link rel="icon" href="logo.ico" type="image/x-icon">
  <script src="https://www.gstatic.com/firebasejs/11.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.7.1/firebase-firestore-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="/shared/sophia-unified-system.js"></script>
  <script src="js/critical-fixes.js"></script>
  <style>
    :root { 
      --nav-bg: #003057; 
      --nav-fg: #fff; 
      --bg: linear-gradient(135deg, #fbecec 0%, #f8fafc 100%); 
      --card: #ffffff; 
      --accent: #660000; 
      --text: #2c2c2c;
      --text-light: #64748b;
      --text-muted: #94a3b8;
      --border: #e2e8f0;
      --border-light: #f1f5f9;
      --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --border-radius: 12px;
      --border-radius-lg: 16px;
      --success: #28a745;
      --warning: #ffc107;
      --error: #dc3545;
      --info: #17a2b8;
      --spacing-xs: 4px;
      --spacing-sm: 8px;
      --spacing-md: 16px;
      --spacing-lg: 24px;
      --spacing-xl: 32px;
      --spacing-2xl: 48px;
      --nav-height: 64px;
      --font-primary: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body { 
      font-family: var(--font-primary); 
      background: var(--bg); 
      color: var(--text);
      line-height: 1.6;
      font-size: 14px;
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .nav-logo { height: 42px; margin-right: 16px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3)); transition: var(--transition); }
    .nav-logo:hover { transform: scale(1.05) rotate(2deg); }
    .nav-title { 
      font-size: 1.4em; font-weight: 600; letter-spacing: -0.5px; 
      background: linear-gradient(45deg, #fff, #e3f2fd); -webkit-background-clip: text;
      -webkit-text-fill-color: transparent; background-clip: text; 
    }
    #staffName { 
      font-weight: 500; opacity: 0; transform: translateX(-20px); transition: var(--transition);
      padding: 6px 12px; background: rgba(255,255,255,0.1); border-radius: 20px;
      backdrop-filter: blur(5px); color: var(--nav-fg);
    }
    #staffName.loaded { opacity: 1; transform: translateX(0); }
    .theme-btn { 
      background: none; border: none; color: var(--nav-fg); font-size: 1.4em; cursor: pointer;
      padding: 8px; border-radius: 50%; transition: var(--transition); text-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .theme-btn:hover { background: rgba(255,255,255,0.1); transform: scale(1.1) rotate(15deg); }
    .dropdown { position: relative; }
    .dropbtn { 
      background: rgba(255,255,255,0.1); border: none; color: var(--nav-fg); padding: 10px 16px;
      font-size: 0.95em; cursor: pointer; border-radius: 8px; transition: var(--transition);
      font-weight: 500; backdrop-filter: blur(5px); display: inline-flex; 
      align-items: center; justify-content: center; 
    }
    .dropbtn:hover { background: rgba(255,255,255,0.2); transform: translateY(-1px); }
    .dropdown-content { 
      display: none; position: absolute; right: 0; background: var(--card-bg); min-width: 220px;
      box-shadow: var(--shadow-lg); z-index: 1001; border-radius: 12px;
      border: 1px solid rgba(0,0,0,0.1); overflow: hidden; backdrop-filter: blur(20px); 
      padding-top: 8px;
    }
    .dropdown-content a, .dropdown-content button { 
      padding: 12px 20px; text-decoration: none; display: block; color: var(--nav-bg); 
      background: none; border: none; width: 100%; text-align: left; cursor: pointer;
      font-size: 0.95em; font-weight: 500; transition: var(--transition); position: relative; overflow: hidden;
    }
    .dropdown-content a::before, .dropdown-content button::before { 
      content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%;
      background: linear-gradient(90deg, transparent, rgba(0,48,87,0.05), transparent); transition: left 0.3s ease;
    }
    .dropdown-content a:hover::before, .dropdown-content button:hover::before { left: 100%; }
    .dropdown-content a:hover, .dropdown-content button:hover { background: rgba(0,48,87,0.08); transform: translateX(4px); }
    .dropdown:hover .dropdown-content { display: block; animation: fadeInUp 0.2s ease; }
    .dropdown-content a.active {
      background-color: #f0f0f0; /* A light grey background */
      color: var(--accent);
      font-weight: 600;
      pointer-events: none; /* Make it non-clickable */
    }
    .badge { 
      background: var(--accent); color: #fff; border-radius: 50px; padding: 4px 8px; 
      font-size: 0.75em; margin-left: 8px; font-weight: 600; min-width: 20px; text-align: center;
      animation: pulse 2s infinite, glow 2s infinite; box-shadow: 0 2px 4px rgba(102, 0, 0, 0.3);
    }
    
    .container { max-width: 1400px; margin: 0 auto; padding: var(--spacing-lg); min-height: calc(100vh - var(--nav-height)); }
    
    .wizard-progress { display: flex; justify-content: space-between; margin-bottom: var(--spacing-2xl); position: relative; }
    .wizard-progress::before { content: ''; position: absolute; top: 50%; left: 0; right: 0; height: 4px; background: var(--border); transform: translateY(-50%); z-index: -1; }
    .progress-line { position: absolute; top: 50%; left: 0; height: 4px; background: var(--accent); transform: translateY(-50%); width: 0%; transition: width 0.5s ease; z-index: -1; }
    .wizard-step { display: flex; flex-direction: column; align-items: center; text-align: center; gap: var(--spacing-sm); background: var(--bg); padding: 0 var(--spacing-md); }
    .step-circle { width: 40px; height: 40px; border-radius: 50%; border: 4px solid var(--border); background: var(--card); display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 1.2rem; transition: all 0.3s ease; }
    .step-label { font-weight: 500; color: var(--text-light); transition: color 0.3s ease; }
    .wizard-step.active .step-circle { border-color: var(--accent); color: var(--accent); }
    .wizard-step.active .step-label { color: var(--accent); font-weight: 600; }
    .wizard-step.completed .step-circle { background: var(--accent); border-color: var(--accent); color: white; }
    
    .page-header { text-align: center; margin-bottom: var(--spacing-md); padding: var(--spacing-xl) 0 var(--spacing-md) 0; }
    .page-title { font-size: 2.5rem; font-weight: 700; color: var(--accent); margin-bottom: var(--spacing-sm); text-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .page-subtitle { font-size: 1.1rem; color: var(--text-light); max-width: 600px; margin: 0 auto var(--spacing-md); }
    .weekly-affirmation-stats { text-align: center; font-size: 1rem; color: var(--text); background-color: rgba(255,255,255,0.7); padding: var(--spacing-sm) var(--spacing-md); border-radius: var(--border-radius); display: inline-block; margin-bottom: var(--spacing-2xl); box-shadow: var(--shadow); }
    #totalWeeklyAffirmationsCount { font-weight: bold; color: var(--accent); }
    
    .form-section { background: var(--card); border-radius: var(--border-radius-lg); padding: var(--spacing-xl); box-shadow: var(--shadow-lg); border: 1px solid var(--border-light); }
    .section-title { font-size: 1.4rem; font-weight: 600; color: var(--accent); margin-bottom: var(--spacing-lg); display: flex; align-items: center; gap: var(--spacing-sm); }
    .section-title::before { content: ''; width: 4px; height: 24px; background: var(--accent); border-radius: 2px; }
    
    .student-search-container { position: relative; margin-bottom: var(--spacing-lg); }
    .search-input { width: 100%; padding: 12px 16px; border: 2px solid var(--border); border-radius: var(--border-radius); font-size: 1rem; transition: border-color 0.2s ease; }
    .search-input:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px rgba(102, 0, 0, 0.1); }
    .search-dropdown { position: absolute; top: 100%; left: 0; right: 0; background: var(--card); border: 1px solid var(--border); border-radius: var(--border-radius); box-shadow: var(--shadow-lg); max-height: 200px; overflow-y: auto; z-index: 100; display: none; }
    .student-option { padding: 12px 16px; cursor: pointer; border-bottom: 1px solid var(--border-light); transition: background-color 0.2s ease; }
    .student-option:hover { background-color: var(--border-light); }
    .student-option:last-child { border-bottom: none; }
    
    .selected-students { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: var(--spacing-md); margin-top: var(--spacing-md); min-height: 120px; padding: var(--spacing-md); border: 2px dashed var(--border); border-radius: var(--border-radius); }
    .student-card { display: flex; flex-direction: column; align-items: center; background: var(--card); padding: var(--spacing-md); border-radius: var(--border-radius); box-shadow: var(--shadow); border: 1px solid var(--border); position: relative; transition: transform 0.2s ease; }
    .student-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-lg); }
    .student-photo { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; border: 3px solid var(--accent); margin-bottom: var(--spacing-sm); }
    .student-name { font-weight: 600; text-align: center; color: var(--text); font-size: 0.9rem; margin-bottom: var(--spacing-xs); }
    .student-details { font-size: 0.8rem; color: var(--text-light); text-align: center; }
    .remove-student { background: none; border: none; color: white; cursor: pointer; font-size: 1.1rem; line-height: 1; padding: 0; margin-left: var(--spacing-xs); }
    .remove-student:hover { opacity: 0.7; }
    
    .pb4l-categories { display: grid; grid-template-columns: 1fr; gap: var(--spacing-md); }
    .category-section { border: 2px solid var(--border); border-radius: var(--border-radius-lg); overflow: hidden; background: var(--card); }
    .category-header { background: linear-gradient(135deg, var(--accent), #800000); color: white; padding: var(--spacing-lg); font-weight: 600; font-size: 1.2rem; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: background 0.2s ease; }
    .category-header:hover { background: linear-gradient(135deg, #800000, var(--accent)); }
    .category-toggle { font-size: 1.4rem; transition: transform 0.3s ease; }
    .category-content { background: var(--card); padding: var(--spacing-lg); display: none; border-top: 1px solid var(--border-light); animation: fadeIn 0.3s ease; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .category-content.expanded { display: block; }
    .context-section { margin-bottom: var(--spacing-lg); }
    .context-section:last-child { margin-bottom: 0; }
    .context-title { font-size: 1rem; font-weight: 600; color: var(--accent); margin-bottom: var(--spacing-md); padding-bottom: var(--spacing-sm); border-bottom: 1px solid var(--border-light); }
    .affirmation-grid { display: grid; grid-template-columns: 1fr; gap: var(--spacing-sm); }
    .affirmation-item { display: flex; align-items: flex-start; gap: var(--spacing-sm); padding: var(--spacing-md); border-radius: var(--border-radius); cursor: pointer; transition: all 0.2s ease; border: 2px solid transparent; }
    .affirmation-item:hover { background: rgba(102, 0, 0, 0.05); border-color: rgba(102,0,0,0.1); }
    .affirmation-item.selected { background: rgba(102, 0, 0, 0.1); border-color: var(--accent); box-shadow: 0 0 10px rgba(102,0,0,0.1); }
    .affirmation-checkbox { margin-top: 4px; transform: scale(1.2); accent-color: var(--accent); flex-shrink: 0; }
    .affirmation-text { font-size: 0.95rem; line-height: 1.5; flex: 1; }
    
    .summary-grid { display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-xl); }
    .summary-section h4 { color: var(--accent); margin-bottom: var(--spacing-md); font-size: 1.1rem; }
    .summary-list { background: var(--border-light); border-radius: var(--border-radius); padding: var(--spacing-md); min-height: 100px; max-height: 200px; overflow-y: auto; }
    .summary-item { padding: var(--spacing-sm); margin-bottom: var(--spacing-xs); background: white; border-radius: 4px; border-left: 3px solid var(--accent); font-size: 0.9rem; }
    
    .action-buttons { display: flex; gap: var(--spacing-md); justify-content: center; margin-top: var(--spacing-xl); margin-bottom: var(--spacing-2xl); }
    .btn { padding: 12px 24px; border: none; border-radius: var(--border-radius); font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.2s ease; display: inline-flex; align-items: center; gap: var(--spacing-sm); }
    .btn-primary { background: var(--accent); color: white; }
    .btn-primary:hover { background: #800000; transform: translateY(-1px); box-shadow: var(--shadow-lg); }
    .btn-secondary { background: var(--border); color: var(--text); }
    .btn-secondary:hover { background: var(--text-muted); color: white; }
    
    .toast { position: fixed; top: calc(var(--nav-height) + 20px); right: 20px; background: var(--card-bg); border: 1px solid #e0e0e0; border-radius: 12px; padding: 16px 20px; box-shadow: var(--shadow-lg); display: none; z-index: 10000; max-width: 400px; transform: translateX(450px); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); backdrop-filter: blur(10px); }
    .toast.show { display: block; transform: translateX(0); }
    .toast.success { border-left: 4px solid var(--success); background: linear-gradient(135deg, rgba(40, 167, 69, 0.05), rgba(40, 167, 69, 0.02)); }
    .toast.error { border-left: 4px solid var(--error); background: linear-gradient(135deg, rgba(220, 53, 69, 0.05), rgba(220, 53, 69, 0.02)); }
    .toast.warning { border-left: 4px solid var(--warning); background: linear-gradient(135deg, rgba(255, 193, 7, 0.05), rgba(255, 193, 7, 0.02)); }
    .toast.info { border-left: 4px solid var(--info); background: linear-gradient(135deg, rgba(23, 162, 184, 0.05), rgba(23, 162, 184, 0.02)); }
    .toast-close { position: absolute; top: 8px; right: 12px; background: none; border: none; font-size: 1.4em; cursor: pointer; color: #999; line-height: 1; padding: 4px; border-radius: 4px; transition: var(--transition); }
    .toast-close:hover { background: rgba(0,0,0,0.1); color: #666; }
    
    .loading { display: inline-flex; align-items: center; gap: var(--spacing-sm); }
    .spinner { width: 16px; height: 16px; border: 2px solid var(--border); border-top: 2px solid var(--accent); border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    #affirmationHistorySection { margin-top: var(--spacing-2xl); }
    .history-controls { display: flex; gap: var(--spacing-md); margin-bottom: var(--spacing-lg); align-items: flex-end; }
    .history-controls .search-input { flex-grow: 1; }
    .history-list-item { background: var(--border-light); padding: var(--spacing-md); border-radius: var(--border-radius); margin-bottom: var(--spacing-md); border-left: 4px solid var(--info); }
    .history-list-item p { margin: var(--spacing-xs) 0; }
    .history-list-item strong { color: var(--accent); }
    .history-list-item .affirmation-text-history { font-style: italic; color: var(--text-light); }
    #affirmationHistoryList { max-height: 300px; overflow-y: auto; padding-right: 10px; }
    
    @media (max-width: 1200px) { .affirmation-form, .summary-grid { grid-template-columns: 1fr; gap: var(--spacing-xl); } }
    @media (max-width: 768px) {
      .container, .form-section { padding: var(--spacing-lg); }
      .page-title { font-size: 2rem; }
      .action-buttons { flex-direction: column; align-items: center; }
      .btn { width: 100%; max-width: 300px; }
      .history-controls { flex-direction: column; align-items: stretch; }
      .toast { right: 16px; left: 16px; max-width: none; transform: translateY(-100px); }
      .toast.show { transform: translateY(0); }
    }
    
    @media (prefers-reduced-motion: reduce) { *, *::before, *::after { animation-duration: 0.01ms !important; animation-iteration-count: 1 !important; transition-duration: 0.01ms !important; } }
    *:focus-visible { outline: 2px solid var(--accent); outline-offset: 2px; }

    .dark-mode {
      --bg: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%); --card-bg: #2d2d2d;
      --text: #e0e0e0; --border: #444; --border-light: #383838;
    }
    .dark-mode .search-input, .dark-mode .search-dropdown, .dark-mode .student-option:hover,
    .dark-mode .selected-students, .dark-mode .student-card, .dark-mode .category-section,
    .dark-mode .category-content, .dark-mode .context-title, .dark-mode .affirmation-item:hover,
    .dark-mode .affirmation-item.selected, .dark-mode .summary-list, .dark-mode .summary-item,
    .dark-mode .history-list-item, .dark-mode .weekly-affirmation-stats {
      background-color: var(--card-bg); color: var(--text); border-color: var(--border);
    }
    .dark-mode .student-option:hover { background-color: #404040; }
    .dark-mode .affirmation-item:hover { background: rgba(224, 224, 224, 0.05); border-color: rgba(224,224,224,0.2); }
    .dark-mode .affirmation-item.selected { background: rgba(224, 224, 224, 0.1); border-color: var(--nav-fg); }
    .dark-mode .page-subtitle, .dark-mode .student-details, .dark-mode .history-list-item .affirmation-text-history { color: #aaa; }
    .dark-mode .toast { background: var(--card-bg); border-color: #444; }
    .dark-mode .dropdown-content { background-color: var(--card-bg); border-color: #444; }
    .dark-mode .dropdown-content a, .dark-mode .dropdown-content button { color: var(--nav-fg); }
    .dark-mode .dropdown-content a:hover, .dark-mode .dropdown-content button:hover { background-color: #404040; }
    .dark-mode .dropbtn { background: #404040; color: var(--nav-fg); }
    .dark-mode .dropbtn:hover { background-color: #555; }
  </style>
</head>

<body>
  <!-- Enhanced Navigation -->
  <nav class="nav-bar" role="navigation" aria-label="Main navigation">
    <div class="nav-left">
      <img src="crest.png" alt="College Crest" class="nav-logo">
    </div>
    <div class="nav-title">‚ú® Positive Affirmations</div>
    <div class="nav-right">
      <div class="nav-links">
        <span id="staffName" aria-live="polite"></span>
        <button class="theme-btn" id="themeToggle" title="Toggle dark mode" aria-label="Toggle dark mode">üåì</button>
        <div class="dropdown">
          <button class="dropbtn" aria-label="Navigation menu" aria-expanded="false" aria-haspopup="true">
            ‚ò∞ Menu
          </button>
          <div class="dropdown-content" role="menu">
            <a href="home.html" onclick="navigate('home.html'); return false;" role="menuitem">üè† Home</a>
            <a href="staff.html" onclick="navigate('staff.html'); return false;" role="menuitem">üìù Infringement Tracker</a>
            <a href="outofclass.html" onclick="navigate('outofclass.html'); return false;" role="menuitem">üè´ Out-of-Class Logger</a>
            <a href="positiveaffirmations.html" onclick="navigate('positiveaffirmations.html'); return false;" role="menuitem">‚ú® Positive Affirmations</a>
            <a href="reengagementroom.html" onclick="navigate('reengagementroom.html'); return false;" role="menuitem">üîÑ Re-Engagement Room</a>
            <a href="admin.html" id="adminLink" onclick="navigate('admin.html'); return false;" role="menuitem">
              üë• Admin Dashboard 
              <span id="badge" class="badge" style="display:none;" aria-label="notifications"></span>
            </a>
            <button onclick="logout(); return false;" role="menuitem">üö™ Logout</button>
          </div>
        </div>
      </div>
    </div>
  </nav>

  <!-- Main Container -->
  <div class="container">
    <header class="page-header">
      <h1 class="page-title">‚ú® Positive Affirmations</h1>
      <p class="page-subtitle">Celebrate student achievements and reinforce positive behaviors aligned with our PB4L values</p>
      <div class="weekly-affirmation-stats">Total Affirmations This Week: <span id="totalWeeklyAffirmationsCount">0</span></div>
    </header>

    <div class="wizard-progress">
      <div class="progress-line" id="progressLine"></div>
      <div class="wizard-step active" id="step1"><div class="step-circle">1</div><div class="step-label">Select Students</div></div>
      <div class="wizard-step" id="step2"><div class="step-circle">2</div><div class="step-label">Choose Affirmations</div></div>
      <div class="wizard-step" id="step3"><div class="step-circle">3</div><div class="step-label">Review & Submit</div></div>
    </div>

    <div id="wizard-content">
      <div id="wizard-step-1" class="form-section">
        <h2 class="section-title">üë• Select Students</h2>
        <div class="student-search-container">
          <input type="text" class="search-input" id="studentSearch" placeholder="Search for students by name or BCE ID..." autocomplete="off">
          <div class="search-dropdown" id="searchDropdown"></div>
        </div>
        <div class="selected-students" id="selectedStudents">
          <p style="color: var(--text-muted); font-style: italic; margin: auto;">Search and select students above</p>
        </div>
      </div>

      <div id="wizard-step-2" class="form-section" style="display: none;">
        <h2 class="section-title">üåü Choose Affirmations</h2>
        <div class="student-search-container">
          <input type="text" class="search-input" id="affirmationSearch" placeholder="Search for affirmations..." autocomplete="off">
        </div>
        <div class="pb4l-categories" id="pb4lCategories"></div>
      </div>

      <div id="wizard-step-3" class="form-section" style="display: none;">
        <h2 class="section-title">üìã Summary & Review</h2>
        <div class="summary-grid">
          <div class="summary-section">
            <h4>Selected Students (<span id="studentCount">0</span>)</h4>
            <div class="summary-list" id="selectedStudentsList"></div>
          </div>
          <div class="summary-section">
            <h4>Selected Affirmations (<span id="affirmationCount">0</span>)</h4>
            <div class="summary-list" id="selectedAffirmationsList"></div>
          </div>
        </div>
      </div>
    </div>

    <div class="action-buttons">
      <button class="btn btn-secondary" id="prevBtn" onclick="changeStep(-1)" style="display: none;">‚¨ÖÔ∏è Back</button>
      <button class="btn btn-primary" id="nextBtn" onclick="changeStep(1)">Next ‚û°Ô∏è</button>
      <button class="btn btn-primary" id="saveBtn" onclick="saveAffirmations()" style="display: none;">üíæ Save Affirmations</button>
      <button class="btn btn-secondary" id="clearBtn" onclick="clearAll()">üóëÔ∏è Clear All</button>
    </div>

    <section id="affirmationHistorySection" class="form-section" style="margin-top: var(--spacing-2xl);">
      <h2 class="section-title">üìú Previous Affirmations</h2>
      <div id="affirmationHistoryList">
        <p style="color: var(--text-muted); text-align: center;">Select a student to view their affirmation history.</p>
      </div>
    </section>
  </div>

  <div id="toast" class="toast" role="alert" aria-live="assertive">
    <button class="toast-close" onclick="closeToast()" aria-label="Close notification">&times;</button>
    <div id="toastMessage"></div>
  </div>

  <script>
    let studentsData = [], selectedStudents = [], selectedAffirmations = [], allAffirmationHistory = [];
    let loggedInStaffDetails = null, currentStep = 1;
    const THEME_KEY = 'sophia_theme';
    
    const firebaseConfig = { apiKey:'AIzaSyD0yaJtrClhyXWjBqDmtdxdM2kWl8AvtKU', authDomain:'sophia-infringements.firebaseapp.com', projectId:'sophia-infringements' };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    
    const pb4lCategories = {
      'RESPECT FOR OUR LEARNING': { emoji: 'üìö', contexts: { 'WHEN IN THE CLASSROOM': ['You came prepared to learn and ready to engage', 'You actively participated in classroom learning', 'You persevered and persisted with your learning', 'You asked thoughtful questions to improve understanding', 'You completed home learning appropriately', 'You respected other students\' rights to learn', 'You respected the thoughts and opinions of others', 'You assisted others to achieve positive results'], 'WHEN OUTSIDE': ['You engaged in learning across the entire campus', 'You moved promptly to class and lined up respectfully', 'You looked after school equipment and grounds', 'You moved around the school safely', 'You celebrated achievements respectfully'], 'WHEN WE GATHER AS COMMUNITY': ['You were open to the opinions of others', 'You listened and shared respectfully', 'You celebrated learning achievements appropriately'], 'WHEN INTERACTING WITH ICT': ['You used technology appropriately for learning', 'You used school devices for educational purposes', 'You supported your learning with appropriate technology use', 'You stored personal devices responsibly'], 'WHEN IN THE WIDER COMMUNITY': ['You embraced learning opportunities in the community', 'You celebrated learning success appropriately'] } },
      'RESPECT FOR INTEGRAL ECOLOGY': { emoji: 'üå±', contexts: { 'WHEN IN THE CLASSROOM': ['You respected the learning environment and left it better than you found it', 'You understood your impact on the College community', 'You respected diverse views, opinions and cultures', 'You respected your own and others\' belongings'], 'WHEN OUTSIDE': ['You disposed of rubbish appropriately', 'You helped keep the College grounds clean', 'You cared for creation by staying off garden beds', 'You left your areas neat and tidy', 'You stored personal devices responsibly'], 'WHEN WE GATHER AS COMMUNITY': ['You recognised sacred spaces and entered with respect', 'You took care when moving through and around equipment'], 'WHEN INTERACTING WITH ICT': ['You created a positive online environment', 'You considered your digital footprint thoughtfully', 'You acted safely and responsibly online'], 'WHEN IN THE WIDER COMMUNITY': ['You respected all public spaces', 'You cared for creation by walking on provided paths'] } },
      'RESPECT FOR OUR FAITH': { emoji: 'üôè', contexts: { 'WHEN IN THE CLASSROOM': ['You actively participated in prayer, liturgy, song and Sophia Stillness', 'You lived the Gospel values in your actions', 'You respected the opinions of others'], 'WHEN OUTSIDE': ['You treated others and their property with respect', 'You spoke and acted respectfully towards peers and staff', 'You took care of creation by caring for the environment', 'You put rubbish in bins and picked up others\' rubbish'], 'WHEN WE GATHER AS COMMUNITY': ['You recognised sacred spaces and entered with dignity', 'You participated and listened actively', 'You listened and shared respectfully', 'You were open to the opinions of others', 'You respected guests, presenters and speakers'], 'WHEN INTERACTING WITH ICT': ['You spoke and acted respectfully in digital spaces', 'You respected your dignity and the dignity of others online'], 'WHEN IN THE WIDER COMMUNITY': ['You represented yourself and the College with pride', 'You spoke respectfully to community members', 'You were open to the opinions of others', 'You sought to see the good in others', 'You strived to present the best version of yourself'] } },
      'RESPECT OUR ENGAGEMENT WITH OURSELVES AND OTHERS': { emoji: 'ü§ù', contexts: { 'WHEN IN THE CLASSROOM': ['You spoke and acted respectfully towards peers, staff and yourself', 'You used kind and encouraging language in all interactions', 'You offered help and support to others when needed', 'You took responsibility for your roles in group tasks', 'You contributed ideas and listened actively during discussions', 'You attended school and class on time, prepared to participate', 'You wore your uniform correctly with pride'], 'WHEN OUTSIDE': ['You were accountable for your words and actions', 'You treated others and their property with respect', 'You practiced sun safety appropriately', 'You remained in boundary areas as required', 'You played appropriately with others', 'You wore your uniform correctly with pride'], 'WHEN WE GATHER AS COMMUNITY': ['You participated and listened actively', 'You moved quickly and quietly to gathering areas', 'You respected guests and presenters', 'You brought the best version of yourself', 'You wore your uniform correctly with pride'], 'WHEN INTERACTING WITH ICT': ['You communicated in a polite and respectful manner', 'You obtained permission before sharing images', 'You protected the privacy of yourself and others', 'You reported inappropriate posts responsibly'], 'WHEN IN THE WIDER COMMUNITY': ['You wore your uniform correctly with pride', 'You followed instructions from staff and community adults', 'You were aware of the safety of others', 'You presented the best version of yourself'] } }
    };

    document.addEventListener('DOMContentLoaded', async () => {
      const currentPage = window.location.pathname.split('/').pop();
      const links = document.querySelectorAll('.dropdown-content a');
      links.forEach(link => {
          const linkPage = link.getAttribute('href');
          if (linkPage === currentPage) {
              link.classList.add('active');
              link.setAttribute('aria-current', 'page');
          }
      });
      
      loggedInStaffDetails = JSON.parse(localStorage.getItem('loggedInStaff')); 
      if (!loggedInStaffDetails) {
        localStorage.setItem('redirectUrlAfterLogin', window.location.href); 
        window.location.href = 'index.html';
        return; 
      }
      initializeTheme();
      await initializePage();
    });

    async function initializePage() {
      try {
        document.getElementById('affirmationSearch').addEventListener('input', filterAffirmations);
        showToast('Loading system data...', 'info', 2000);
        
        const staffNameElement = document.getElementById('staffName');
        if (loggedInStaffDetails && staffNameElement) {
          staffNameElement.textContent = loggedInStaffDetails['staff name'] || 'Staff Member';
           setTimeout(() => { staffNameElement.classList.add('loaded'); }, 100);
        }
        
        const themeToggleBtn = document.getElementById('themeToggle');
        if (themeToggleBtn) themeToggleBtn.addEventListener('click', toggleTheme);

        await Promise.all([ loadStudentsData(), displayTotalWeeklyAffirmations() ]);
        
        initializePB4LCategories();
        setupStudentSearch();
        updateAffirmationHistoryVisibility(); 
        
        showToast('‚úÖ System loaded successfully!', 'success', 2000);
      } catch (error) {
        console.error('Error initializing page:', error);
        showToast('‚ùå Error loading system data', 'error');
      }
    }

    async function loadStudentsData() {
      try {
        const response = await fetch('/data/students.csv');
        const csvText = await response.text();
        const parsed = Papa.parse(csvText, { header: true, skipEmptyLines: true, transformHeader: (h) => h.trim() });
        studentsData = parsed.data.filter(s => s.FirstName && s.LegalSurname1 && s.BCEID1);
      } catch (error) { console.error('Error loading students:', error); throw error; }
    }

    function initializePB4LCategories() {
      const container = document.getElementById('pb4lCategories');
      container.innerHTML = ''; 
      Object.entries(pb4lCategories).forEach(([categoryName, categoryData]) => {
        const categorySection = document.createElement('div');
        categorySection.className = 'category-section';
        const categoryHeader = document.createElement('div');
        categoryHeader.className = 'category-header';
        categoryHeader.innerHTML = `<span>${categoryData.emoji} ${categoryName}</span><span class="category-toggle" id="toggle-${categoryName.replace(/\s+/g, '-')}">‚ñº</span>`;
        categoryHeader.onclick = () => toggleCategory(categoryName.replace(/\s+/g, '-'));
        const categoryContent = document.createElement('div');
        categoryContent.className = 'category-content';
        categoryContent.id = `content-${categoryName.replace(/\s+/g, '-')}`;
        Object.entries(categoryData.contexts).forEach(([contextName, affirmations]) => {
          const contextSection = document.createElement('div');
          contextSection.className = 'context-section';
          const contextTitle = document.createElement('h4');
          contextTitle.className = 'context-title';
          contextTitle.textContent = contextName;
          contextSection.appendChild(contextTitle);
          const affirmationGrid = document.createElement('div');
          affirmationGrid.className = 'affirmation-grid';
          affirmations.forEach((affirmation, affIndex) => {
            const affirmationId = `${categoryName.replace(/\s+/g, '-')}-${contextName.replace(/\s+/g, '-')}-${affIndex}`;
            const affirmationItem = document.createElement('div');
            affirmationItem.className = 'affirmation-item';
            affirmationItem.onclick = () => toggleAffirmationItem(affirmationId);
            affirmationItem.innerHTML = `<input type="checkbox" class="affirmation-checkbox" id="${affirmationId}" onchange="handleAffirmationChange(this)"><span class="affirmation-text">${affirmation}</span>`;
            affirmationGrid.appendChild(affirmationItem);
          });
          contextSection.appendChild(affirmationGrid);
          categoryContent.appendChild(contextSection);
        });
        categorySection.appendChild(categoryHeader);
        categorySection.appendChild(categoryContent);
        container.appendChild(categorySection);
      });
    }

    function toggleAffirmationItem(affirmationId) {
      const checkbox = document.getElementById(affirmationId);
      if (checkbox) {
        checkbox.checked = !checkbox.checked;
        checkbox.dispatchEvent(new Event('change', { bubbles: true }));
      }
    }

    function handleAffirmationChange(checkboxElement) {
      const item = checkboxElement.closest('.affirmation-item');
      if (item) item.classList.toggle('selected', checkboxElement.checked);
      updateSelectedAffirmations();
    }

    function setupStudentSearch() {
      const searchInput = document.getElementById('studentSearch');
      const dropdown = document.getElementById('searchDropdown');
      let searchTimeout;
      searchInput.addEventListener('input', (e) => {
        clearTimeout(searchTimeout);
        const query = e.target.value.trim().toLowerCase();
        if (query.length < 2) { dropdown.style.display = 'none'; return; }
        searchTimeout = setTimeout(() => performSearch(query), 300);
      });
      searchInput.addEventListener('focus', () => {
        if (searchInput.value.length >= 2) performSearch(searchInput.value.trim().toLowerCase());
      });
      document.addEventListener('click', (e) => {
        if (!searchInput.contains(e.target) && !dropdown.contains(e.target)) dropdown.style.display = 'none';
      });
    }

    function performSearch(query) {
      const dropdown = document.getElementById('searchDropdown');
      const results = studentsData.filter(student => 
        (`${student.FirstName} ${student.LegalSurname1}`.toLowerCase().includes(query) || 
         student.BCEID1?.toLowerCase().includes(query))
      ).slice(0, 8);
      
      dropdown.innerHTML = results.length > 0 
        ? results.map(student => `
            <div class="student-option" onclick="selectStudent(studentsData.find(s => s.BCEID1 === '${student.BCEID1}'))">
              <div><strong>${student.LegalSurname1}, ${student.FirstName}</strong><div class="student-id">${student.BCEID1}</div></div>
              <div class="student-house">${student.HouseName || ''}</div>
            </div>`).join('')
        : '<div class="student-option">No students found</div>';
      dropdown.style.display = 'block';
    }

    function selectStudent(student) {
      if (!selectedStudents.some(s => s.BCEID1 === student.BCEID1)) {
        selectedStudents.push(student);
        updateSelectedStudentsDisplay();
        updateSummary();
        updateAffirmationHistoryVisibility();
        loadAffirmationHistory();
      } else {
        showToast('Student already selected.', 'warning');
      }
      document.getElementById('studentSearch').value = '';
      document.getElementById('searchDropdown').style.display = 'none';
    }

    function updateSelectedStudentsDisplay() {
      const container = document.getElementById('selectedStudents');
      if (selectedStudents.length === 0) {
        container.innerHTML = '<p style="color: var(--text-muted); font-style: italic; margin: auto;">Search and select students above</p>';
        return;
      }
      container.innerHTML = selectedStudents.map(student => `
        <div class="student-card" onmouseenter="loadAffirmationHistory('${student.BCEID1}')">
          <img src="students/${student.BCEID1}.jpg" class="student-photo" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
          <div class="fallback-icon" style="display:none;">üë§</div>
          <div class="student-name">${student.LegalSurname1}, ${student.FirstName}</div>
          <div class="student-details">${student.BCEID1} ‚Ä¢ ${student.HomeGroup || ''} ‚Ä¢ ${student.YearLevelName || ''}</div>
          <button class="remove-student" onclick="removeStudent('${student.BCEID1}')" aria-label="Remove student">√ó</button>
        </div>`).join('');
    }

    function removeStudent(bceid) {
      selectedStudents = selectedStudents.filter(s => s.BCEID1 !== bceid);
      updateSelectedStudentsDisplay();
      updateSummary();
      updateAffirmationHistoryVisibility();
      if (selectedStudents.length > 0) loadAffirmationHistory(selectedStudents[selectedStudents.length - 1].BCEID1);
      else document.getElementById('affirmationHistoryList').innerHTML = '<p style="color: var(--text-muted); text-align: center;">Select a student to view their affirmation history.</p>';
    }

    function toggleCategory(categoryNameSuffix) {
      const content = document.getElementById(`content-${categoryNameSuffix}`);
      const toggle = document.getElementById(`toggle-${categoryNameSuffix}`);
      const isExpanded = content.classList.toggle('expanded');
      toggle.textContent = isExpanded ? '‚ñ≤' : '‚ñº';
    }

    function updateSelectedAffirmations() {
      const checkboxes = document.querySelectorAll('.affirmation-checkbox:checked');
      selectedAffirmations = Array.from(checkboxes).map(cb => cb.closest('.affirmation-item').querySelector('.affirmation-text').textContent);
      updateSummary();
    }

    function updateSummary() {
      if (currentStep !== 3) return;
      document.getElementById('studentCount').textContent = selectedStudents.length;
      document.getElementById('affirmationCount').textContent = selectedAffirmations.length;
      document.getElementById('selectedStudentsList').innerHTML = selectedStudents.length > 0 ? selectedStudents.map(s => `<div class="summary-item">${s.LegalSurname1}, ${s.FirstName} (${s.BCEID1})</div>`).join('') : '<p style="color: var(--text-muted); font-style: italic;">No students selected</p>';
      document.getElementById('selectedAffirmationsList').innerHTML = selectedAffirmations.length > 0 ? selectedAffirmations.map(a => `<div class="summary-item">${a}</div>`).join('') : '<p style="color: var(--text-muted); font-style: italic;">No affirmations selected</p>';
    }

    async function saveAffirmations() {
      if (selectedStudents.length === 0) { showToast('Please select at least one student', 'warning'); return; }
      if (selectedAffirmations.length === 0) { showToast('Please select at least one affirmation', 'warning'); return; }
      
      const saveBtn = document.getElementById('saveBtn');
      saveBtn.innerHTML = '<span class="loading"><span class="spinner"></span>Saving...</span>';
      saveBtn.disabled = true;
      
      try {
        const records = [];
        const timestamp = new Date().toISOString();
        const staffName = loggedInStaffDetails['staff name'] || 'Staff Member';
        const staffEmail = loggedInStaffDetails['email'] || 'noreply@sophiacollege.qld.edu.au';
        
        selectedStudents.forEach(student => {
          selectedAffirmations.forEach(affirmation => {
            records.push({
              timestamp, staffName, staffEmail, 
              studentName: `${student.LegalSurname1}, ${student.FirstName}`, studentBCEID: student.BCEID1,
              studentHouse: student.HouseName || '', studentHomeGroup: student.HomeGroup || '',
              affirmation, id: `${student.BCEID1}-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`
            });
          });
        });
        
        const batch = db.batch();
        records.forEach(record => batch.set(db.collection('affirmations').doc(record.id), record));
        await batch.commit();
        
        await displayTotalWeeklyAffirmations(); 
        showToast(`‚úÖ Successfully saved ${records.length} affirmations!`, 'success');
        clearAll();
      } catch (error) {
        console.error('Error saving affirmations:', error);
        showToast('‚ùå Error saving affirmations', 'error');
      } finally {
        saveBtn.innerHTML = 'üíæ Save Affirmations';
        saveBtn.disabled = false;
      }
    }

    function clearAll() {
      selectedStudents = []; 
      updateSelectedStudentsDisplay();
      document.querySelectorAll('.affirmation-checkbox:checked').forEach(cb => { 
        cb.checked = false; 
        const item = cb.closest('.affirmation-item');
        if (item) item.classList.remove('selected');
      });
      selectedAffirmations = []; 
      updateSummary();
      document.getElementById('studentSearch').value = '';
      document.getElementById('searchDropdown').style.display = 'none';
      updateAffirmationHistoryVisibility();
      document.getElementById('affirmationHistoryList').innerHTML = '<p style="color: var(--text-muted); text-align: center;">Select a student to view their affirmation history.</p>';
      currentStep = 1;
      updateWizardUI();
      showToast('All selections cleared', 'info');
    }

    function showToast(message, type = 'info', duration = 3000) {
      const toast = document.getElementById('toast');
      const messageElement = document.getElementById('toastMessage');
      if (!toast || !messageElement) { alert(`${type.toUpperCase()}: ${message}`); return; }
      toast.className = `toast ${type} show`;
      messageElement.textContent = message;
      setTimeout(() => closeToast(), duration);
    }
    
    function closeToast() {
      const toast = document.getElementById('toast');
      if (toast) {
        toast.classList.remove('show');
      }
    }

    function initializeTheme() {
      const savedTheme = localStorage.getItem(THEME_KEY);
      const themeToggleBtn = document.getElementById('themeToggle');
      if (savedTheme === 'dark' || (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
        document.body.classList.add('dark-mode');
        if (themeToggleBtn) themeToggleBtn.textContent = '‚òÄÔ∏è';
      } else {
        if (themeToggleBtn) themeToggleBtn.textContent = 'üåì';
      }
    }

    function toggleTheme() {
      document.body.classList.toggle('dark-mode');
      const isDark = document.body.classList.contains('dark-mode');
      localStorage.setItem(THEME_KEY, isDark ? 'dark' : 'light');
      const themeToggleBtn = document.getElementById('themeToggle');
      if (themeToggleBtn) themeToggleBtn.textContent = isDark ? '‚òÄÔ∏è' : 'üåì';
    }

    function logout() {
      if (confirm('Are you sure you want to logout?')) {
        localStorage.clear();
        window.location.href = 'index.html';
      }
    }

    function navigate(page) { window.location.href = page; }

    function updateAffirmationHistoryVisibility() {
      document.getElementById('affirmationHistorySection').style.display = selectedStudents.length > 0 ? 'block' : 'none';
    }

    async function loadAffirmationHistory(bceid) {
      const historyListDiv = document.getElementById('affirmationHistoryList');
      if (!bceid) {
        if (selectedStudents.length > 0) bceid = selectedStudents[selectedStudents.length - 1].BCEID1;
        else {
          historyListDiv.innerHTML = '<p style="color: var(--text-muted); text-align: center;">Select a student to view their affirmation history.</p>';
          return;
        }
      }
      historyListDiv.innerHTML = '<p style="color: var(--text-muted); text-align: center;">Loading history...</p>';
      try {
        const snapshot = await db.collection('affirmations').where('studentBCEID', '==', bceid).orderBy('timestamp', 'desc').limit(5).get();
        allAffirmationHistory = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        displayAffirmationHistory(allAffirmationHistory); 
      } catch (error) {
        console.error("Error loading affirmation history: ", error);
        historyListDiv.innerHTML = '<p style="color: var(--danger); text-align: center;">Error loading history.</p>';
      }
    }

    function displayAffirmationHistory(affirmationsToDisplay) {
      const historyListDiv = document.getElementById('affirmationHistoryList');
      if (affirmationsToDisplay.length === 0) {
        historyListDiv.innerHTML = '<p style="color: var(--text-muted); text-align: center;">No affirmations found for this student.</p>';
        return;
      }
      historyListDiv.innerHTML = affirmationsToDisplay.map(r => `
        <div class="history-list-item">
          <p><strong>Affirmation:</strong> <span class="affirmation-text-history">"${r.affirmation || 'N/A'}"</span></p>
          <p><strong>By:</strong> ${r.staffName || 'N/A'} <strong>On:</strong> ${r.timestamp ? new Date(r.timestamp).toLocaleDateString() : 'N/A'}</p>
        </div>`).join('');
    }

    function filterAffirmations() {
      const searchTerm = document.getElementById('affirmationSearch').value.toLowerCase();
      document.querySelectorAll('.affirmation-item').forEach(item => {
        const text = item.querySelector('.affirmation-text').textContent.toLowerCase();
        item.style.display = text.includes(searchTerm) ? 'flex' : 'none';
      });
      document.querySelectorAll('.category-section').forEach(category => {
        const visibleItems = category.querySelectorAll('.affirmation-item[style*="display: flex"]');
        category.style.display = visibleItems.length > 0 ? 'block' : 'none';
        if (searchTerm && visibleItems.length > 0) {
          category.querySelector('.category-content').classList.add('expanded');
          category.querySelector('.category-toggle').textContent = '‚ñ≤';
        }
      });
    }

    function changeStep(direction) {
      const newStep = currentStep + direction;
      if (direction > 0) {
        if (currentStep === 1 && selectedStudents.length === 0) { showToast('Please select at least one student.', 'warning'); return; }
        if (currentStep === 2 && selectedAffirmations.length === 0) { showToast('Please select at least one affirmation.', 'warning'); return; }
      }
      if (newStep >= 1 && newStep <= 3) {
        currentStep = newStep;
        updateWizardUI();
      }
    }

    function updateWizardUI() {
      document.querySelectorAll('#wizard-content .form-section').forEach(el => el.style.display = 'none');
      document.getElementById(`wizard-step-${currentStep}`).style.display = 'block';
      
      document.querySelectorAll('.wizard-step').forEach((step, index) => {
        step.classList.remove('active', 'completed');
        if (index + 1 < currentStep) step.classList.add('completed');
        else if (index + 1 === currentStep) step.classList.add('active');
      });
      
      document.getElementById('progressLine').style.width = `${((currentStep - 1) / 2) * 100}%`;
      document.getElementById('prevBtn').style.display = currentStep > 1 ? 'inline-flex' : 'none';
      document.getElementById('nextBtn').style.display = currentStep < 3 ? 'inline-flex' : 'none';
      document.getElementById('saveBtn').style.display = currentStep === 3 ? 'inline-flex' : 'none';

      if (currentStep === 3) updateSummary();
    }

    async function displayTotalWeeklyAffirmations() {
      const countElement = document.getElementById('totalWeeklyAffirmationsCount');
      if (!countElement) return;
      try {
        const weekAgo = new Date();
        weekAgo.setDate(weekAgo.getDate() - 7);
        weekAgo.setHours(0, 0, 0, 0);
        const snapshot = await db.collection('affirmations').where('timestamp', '>=', weekAgo.toISOString()).get();
        countElement.textContent = snapshot.size;
      } catch (error) {
        console.error("Error loading total weekly affirmations: ", error);
        countElement.textContent = "N/A";
      }
    }
  </script>
</body>
</html>
